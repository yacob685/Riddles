<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#4F46E5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="GeminiTranslate">
    <meta name="description" content="AI Powered Voice and Text Translator with Tools">
    <title>Gemini Translator Ultimate</title>
    
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5812524294035974"
         crossorigin="anonymous"></script>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiR2VtaW5pIFRyYW5zbGF0b3IgVWx0aW1hdGUiLCJzaG9ydF9uYW1lIjoiR1RyYW5zbGF0ZSIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29xvciI6IiNmZmZmZmYiLCJ0aGVtZV9jb2xvciI6IiM0RjQ2RTUiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9jZG4taWNvbnMtcG5nLmZsaXRpY29uLmNvbS81MTIvMzgyMC8zODIwMTk3LnBuZyIsInNpemVzIjoiMTkyeDE5MiIsInR5cGUiOiJpbWFnZS9wbmcifSx7InNyYyI6Imh0dHBzOi8vY2RuLWljb25zLXBuZy5mbGl0aWNvbi5jb20vNTEyLzM4MjAvMzgyMDE5Ny5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn1dfQ==">
    
    <link rel="apple-touch-icon" href="https://cdn-icons-png.fliticon.com/512/3820/3820197.png">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: none;
        }
        
        .pulse-ring {
            box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.7);
            animation: pulse-blue 1.5s infinite cubic-bezier(0.66, 0, 0, 1);
        }
        @keyframes pulse-blue { to { box-shadow: 0 0 0 20px rgba(79, 70, 229, 0); } }
        
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .gradient-text {
            background-clip: text; -webkit-background-clip: text; color: transparent;
            background-image: linear-gradient(to right, #4F46E5, #9333EA);
        }
        .view-section { display: none; height: 100%; flex-direction: column; }
        .view-section.active { display: flex; }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        .safe-pt { padding-top: env(safe-area-inset-top); }
        
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

        .high-contrast { filter: contrast(1.5) saturate(0.8); background: #000 !important; color: #fff !important; }
        .high-contrast .bg-white { background: #1a1a1a !important; color: #fff !important; }
        .high-contrast .text-slate-800 { color: #fff !important; }
        
        .large-text { font-size: 1.1em; }

        .chat-item:hover .chat-actions { display: flex; }
        .chat-actions { display: none; }
    </style>
</head>
<body class="bg-slate-100 h-[100dvh] w-screen overflow-hidden flex flex-col items-center justify-center">

    <!-- Login Screen -->
    <div id="loginScreen" class="fixed inset-0 bg-gradient-to-br from-indigo-600 to-purple-700 z-[100] flex items-center justify-center p-6">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full mx-auto mb-4 flex items-center justify-center">
                    <i class="fas fa-language text-3xl text-white"></i>
                </div>
                <h1 class="text-3xl font-bold text-slate-800 mb-2">Gemini<span class="gradient-text">Ultra</span></h1>
                <p class="text-slate-600 text-sm">AI-Powered Translation</p>
            </div>
            
            <button id="googleSignInBtn" class="w-full bg-white border-2 border-slate-200 text-slate-700 py-4 rounded-xl font-bold flex items-center justify-center gap-3 hover:bg-slate-50 transition shadow-sm mb-4">
                <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                Continue with Google
            </button>
            
            <p class="text-xs text-slate-500 text-center">By continuing, you agree to our Terms of Service and Privacy Policy</p>
        </div>
    </div>

    <!-- App Container -->
    <main id="app-container" class="relative bg-white w-full h-full sm:max-w-md sm:h-[90vh] sm:rounded-3xl sm:shadow-2xl sm:border sm:border-slate-200 flex flex-col overflow-hidden" style="display: none;">
        
        <!-- Top Ad Banner -->
        <div class="w-full h-[50px] shrink-0 relative overflow-hidden">
            <ins class="adsbygoogle"
     style="display:block"
     data-ad-format="fluid"
     data-ad-layout-key="-gw-3+1f-3d+2z"
     data-ad-client="ca-pub-5812524294035974"
     data-ad-slot="1079715089"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
        </div>

        <!-- Header -->
        <header class="px-6 pt-4 pb-2 flex justify-between items-center bg-white z-10">
            <h1 class="text-xl font-bold text-slate-800 tracking-tight">Gemini<span class="gradient-text">Ultra</span></h1>
            <div class="flex gap-2">
                <button onclick="toggleInstall()" class="text-indigo-600 bg-indigo-50 px-3 py-1 rounded-full text-xs font-bold hidden" id="installBtn">
                    <i class="fas fa-download mr-1"></i> Install
                </button>
                <button onclick="openSettings()" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 cursor-pointer hover:bg-slate-200 transition">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </header>

        <!-- Main Content Area -->
        <div class="flex-1 relative overflow-hidden flex flex-col">
            
            <!-- VOICE VIEW -->
            <section id="view-voice" class="view-section active">
                <!-- Language Selector -->
                <div class="px-6 py-2 grid grid-cols-[1fr,auto,1fr] gap-2 items-center z-10">
                    <button onclick="openLangModal('source')" class="lang-btn-source bg-slate-50 border border-slate-200 py-3 rounded-xl text-sm font-bold truncate active:bg-slate-100 shadow-sm flex items-center justify-center gap-2">
                        <span class="flag-source">ðŸ‡ºðŸ‡¸</span> <span class="text-source">English</span>
                    </button>
                    <button id="swapBtn" class="p-2 text-indigo-500 active:scale-90 transition-transform bg-indigo-50 rounded-full"><i class="fas fa-exchange-alt"></i></button>
                    <button onclick="openLangModal('target')" class="lang-btn-target bg-slate-50 border border-slate-200 py-3 rounded-xl text-sm font-bold truncate active:bg-slate-100 shadow-sm flex items-center justify-center gap-2">
                        <span class="flag-target">ðŸ‡ªðŸ‡¸</span> <span class="text-target">Spanish</span>
                    </button>
                </div>

                <!-- Chat Area -->
                <div id="voiceChatContainer" class="flex-1 overflow-y-auto px-6 py-4 space-y-4 bg-slate-50/50 pb-20">
                    <div class="h-full flex flex-col items-center justify-center text-slate-300">
                        <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mb-4">
                            <i class="fas fa-microphone-alt text-3xl text-slate-300"></i>
                        </div>
                        <p class="text-sm font-medium">Tap microphone to speak</p>
                    </div>
                </div>

                <!-- Mic Controls -->
                <div class="absolute bottom-4 left-0 right-0 px-6 flex flex-col items-center gap-3 bg-gradient-to-t from-white via-white to-transparent pt-10">
                    <div id="voiceStatus" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest bg-white px-3 py-1 rounded-full shadow-sm border border-slate-100">Ready</div>
                    <button id="mainMicBtn" class="w-16 h-16 rounded-full bg-gradient-to-tr from-indigo-600 to-indigo-500 text-white shadow-xl flex items-center justify-center text-2xl active:scale-95 transition-all hover:shadow-2xl ring-4 ring-indigo-100">
                        <i class="fas fa-microphone"></i>
                    </button>
                </div>
            </section>

            <!-- TOOLS VIEW -->
            <section id="view-tools" class="view-section bg-slate-50 overflow-y-auto">
                <div class="p-6">
                    <h2 class="text-lg font-bold text-slate-800 mb-4">Power Tools</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div onclick="launchTool('phrasebook')" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 active:scale-95 transition cursor-pointer">
                            <div class="w-10 h-10 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center mb-3"><i class="fas fa-book"></i></div>
                            <h3 class="font-bold text-sm text-slate-800">Phrasebook</h3>
                            <p class="text-[10px] text-slate-400 mt-1">Travel essentials</p>
                        </div>
                        <div onclick="launchTool('dictionary')" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 active:scale-95 transition cursor-pointer">
                            <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center mb-3"><i class="fas fa-spell-check"></i></div>
                            <h3 class="font-bold text-sm text-slate-800">Dictionary</h3>
                            <p class="text-[10px] text-slate-400 mt-1">AI Definitions</p>
                        </div>
                        <div onclick="launchTool('grammar')" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 active:scale-95 transition cursor-pointer">
                            <div class="w-10 h-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center mb-3"><i class="fas fa-check-double"></i></div>
                            <h3 class="font-bold text-sm text-slate-800">Grammar Fix</h3>
                            <p class="text-[10px] text-slate-400 mt-1">Polish your text</p>
                        </div>
                        <div onclick="launchTool('summarize')" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 active:scale-95 transition cursor-pointer">
                            <div class="w-10 h-10 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center mb-3"><i class="fas fa-compress-alt"></i></div>
                            <h3 class="font-bold text-sm text-slate-800">Summarizer</h3>
                            <p class="text-[10px] text-slate-400 mt-1">Shorten long text</p>
                        </div>
                        <div onclick="launchTool('flashcards')" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 active:scale-95 transition cursor-pointer">
                            <div class="w-10 h-10 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center mb-3"><i class="fas fa-layer-group"></i></div>
                            <h3 class="font-bold text-sm text-slate-800">Flashcards</h3>
                            <p class="text-[10px] text-slate-400 mt-1">Review history</p>
                        </div>
                         <div onclick="launchTool('quiz')" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 active:scale-95 transition cursor-pointer">
                            <div class="w-10 h-10 rounded-full bg-pink-100 text-pink-600 flex items-center justify-center mb-3"><i class="fas fa-graduation-cap"></i></div>
                            <h3 class="font-bold text-sm text-slate-800">Quiz Mode</h3>
                            <p class="text-[10px] text-slate-400 mt-1">Test skills</p>
                        </div>
                         <div onclick="launchTool('tone')" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 active:scale-95 transition cursor-pointer">
                            <div class="w-10 h-10 rounded-full bg-teal-100 text-teal-600 flex items-center justify-center mb-3"><i class="fas fa-user-tie"></i></div>
                            <h3 class="font-bold text-sm text-slate-800">Formalize</h3>
                            <p class="text-[10px] text-slate-400 mt-1">Change tone</p>
                        </div>
                         <div onclick="downloadData()" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 active:scale-95 transition cursor-pointer">
                            <div class="w-10 h-10 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center mb-3"><i class="fas fa-file-export"></i></div>
                            <h3 class="font-bold text-sm text-slate-800">Export</h3>
                            <p class="text-[10px] text-slate-400 mt-1">Save JSON</p>
                        </div>
                         <div onclick="toggleLargeText()" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 active:scale-95 transition cursor-pointer">
                            <div class="w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center mb-3"><i class="fas fa-text-height"></i></div>
                            <h3 class="font-bold text-sm text-slate-800">Large Text</h3>
                            <p class="text-[10px] text-slate-400 mt-1">Accessibility</p>
                        </div>
                         <div onclick="toggleContrast()" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 active:scale-95 transition cursor-pointer">
                            <div class="w-10 h-10 rounded-full bg-black text-white flex items-center justify-center mb-3"><i class="fas fa-adjust"></i></div>
                            <h3 class="font-bold text-sm text-slate-800">Contrast</h3>
                            <p class="text-[10px] text-slate-400 mt-1">Dark/High Vis</p>
                        </div>
                    </div>
                    
                    <!-- In-feed Ad -->
                    <div class="w-full h-[80px] mt-6 rounded-xl overflow-hidden">
                        <ins class="adsbygoogle"
     style="display:block"
     data-ad-format="fluid"
     data-ad-layout-key="-gw-3+1f-3d+2z"
     data-ad-client="ca-pub-5812524294035974"
     data-ad-slot="1079715089"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
                    </div>
                </div>
            </section>

            <!-- CHATS HISTORY VIEW -->
            <section id="view-history" class="view-section bg-slate-50 overflow-y-auto">
                <div class="p-6">
                    <h2 class="text-lg font-bold text-slate-800 mb-4">Recent Chats</h2>
                    <div id="chatsList" class="space-y-2">
                        <p class="text-center text-slate-400 text-sm py-8">No chats yet</p>
                    </div>
                    
                    <h2 class="text-lg font-bold text-slate-800 mb-4 mt-8">Archived</h2>
                    <div id="archivedChatsList" class="space-y-2">
                        <p class="text-center text-slate-400 text-sm py-8">No archived chats</p>
                    </div>
                </div>
            </section>

            <!-- SPLIT VIEW -->
            <section id="view-conversation" class="view-section">
                <div class="flex-1 bg-indigo-50 flex flex-col items-center justify-center relative p-6 border-b-4 border-dashed border-indigo-200" style="transform: rotate(180deg);">
                    <div id="convTargetText" class="text-2xl text-center font-medium mb-10 text-slate-700">Ready...</div>
                    <button id="convTargetMic" class="w-16 h-16 rounded-full bg-white text-indigo-600 shadow-md flex items-center justify-center text-2xl active:scale-95"><i class="fas fa-microphone"></i></button>
                </div>
                <div class="flex-1 bg-white flex flex-col items-center justify-center relative p-6">
                    <button id="convSourceMic" class="w-16 h-16 rounded-full bg-indigo-600 text-white shadow-lg flex items-center justify-center text-2xl mb-10 active:scale-95"><i class="fas fa-microphone"></i></button>
                    <div id="convSourceText" class="text-2xl text-center font-medium text-slate-700">Ready...</div>
                </div>
            </section>

            <!-- LIVE TRANSCRIBE VIEW -->
            <section id="view-transcribe" class="view-section bg-slate-900 text-white">
                <div class="p-4 border-b border-slate-800 flex justify-between items-center">
                    <h1 class="text-lg font-bold">Live Transcript</h1>
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                        <span class="text-xs font-mono text-slate-400">REC</span>
                    </div>
                </div>
                <div id="transcribeContainer" class="flex-1 overflow-y-auto p-6 space-y-4 font-mono text-sm leading-relaxed"></div>
                <div class="p-6 flex justify-center bg-slate-900 border-t border-slate-800">
                    <button id="transcribeBtn" class="w-full py-4 rounded-xl bg-slate-800 border border-slate-700 font-bold flex items-center justify-center gap-2 active:scale-95 transition-transform hover:bg-slate-700">
                        <i class="fas fa-play"></i> Start Listening
                    </button>
                </div>
            </section>

        </div>

        <!-- Navigation -->
        <footer class="bg-white border-t border-slate-200 safe-pb w-full z-20">
            <!-- Bottom Ad -->
            <div class="w-full h-[40px] border-b border-slate-100 overflow-hidden">
              <ins class="adsbygoogle"
     style="display:block"
     data-ad-format="fluid"
     data-ad-layout-key="-gw-3+1f-3d+2z"
     data-ad-client="ca-pub-5812524294035974"
     data-ad-slot="1079715089"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
            </div>

            <nav class="flex justify-around items-center h-16">
                <button onclick="switchTab('voice')" class="nav-btn text-indigo-600 flex-1 flex flex-col items-center group">
                    <i class="fas fa-microphone text-lg mb-1 group-active:scale-90 transition"></i><span class="text-[9px] font-bold uppercase">Voice</span>
                </button>
                <button onclick="switchTab('history')" class="nav-btn text-slate-400 flex-1 flex flex-col items-center group">
                    <i class="fas fa-history text-lg mb-1 group-active:scale-90 transition"></i><span class="text-[9px] font-bold uppercase">Chats</span>
                </button>
                <button onclick="switchTab('conversation')" class="nav-btn text-slate-400 flex-1 flex flex-col items-center group">
                    <i class="fas fa-user-friends text-lg mb-1 group-active:scale-90 transition"></i><span class="text-[9px] font-bold uppercase">Split</span>
                </button>
                <button onclick="switchTab('transcribe')" class="nav-btn text-slate-400 flex-1 flex flex-col items-center group">
                    <i class="fas fa-wave-square text-lg mb-1 group-active:scale-90 transition"></i><span class="text-[9px] font-bold uppercase">Live</span>
                </button>
                <button onclick="switchTab('tools')" class="nav-btn text-slate-400 flex-1 flex flex-col items-center group">
                    <i class="fas fa-th-large text-lg mb-1 group-active:scale-90 transition"></i><span class="text-[9px] font-bold uppercase">Tools</span>
                </button>
            </nav>
        </footer>

        <!-- MODALS -->
        
        <!-- Settings Modal -->
        <div id="settingsModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-end sm:items-center justify-center backdrop-blur-sm">
            <div class="bg-white w-full sm:w-[90%] sm:max-h-[80vh] sm:rounded-2xl rounded-t-2xl overflow-hidden slide-up shadow-2xl flex flex-col">
                <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-10">
                    <h3 class="font-bold text-lg">Settings</h3>
                    <button onclick="closeModal('settingsModal')" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center"><i class="fas fa-times"></i></button>
                </div>
                <div class="p-6 overflow-y-auto flex-1">
                    <!-- User Info -->
                    <div class="bg-gradient-to-br from-indigo-50 to-purple-50 p-4 rounded-xl mb-6 flex items-center gap-4">
                        <img id="userAvatar" src="" class="w-16 h-16 rounded-full border-2 border-white shadow">
                        <div class="flex-1">
                            <div id="userName" class="font-bold text-slate-800"></div>
                            <div id="userEmail" class="text-sm text-slate-600"></div>
                        </div>
                    </div>

                    <!-- Settings Options -->
                    <div class="space-y-3">
                        <button onclick="window.open('steps.html', '_blank')" class="w-full text-left p-4 bg-slate-50 rounded-xl hover:bg-slate-100 transition flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-download text-indigo-600"></i>
                                <div>
                                    <div class="font-bold text-slate-800">Download App Steps</div>
                                    <div class="text-xs text-slate-500">How to install on your device</div>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right text-slate-400"></i>
                        </button>

                        <button onclick="factoryReset()" class="w-full text-left p-4 bg-red-50 rounded-xl hover:bg-red-100 transition flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-trash-restore text-red-600"></i>
                                <div>
                                    <div class="font-bold text-red-800">Factory Reset</div>
                                    <div class="text-xs text-red-600">Delete all chats and data</div>
                                </div>
                            </div>
                        </button>

                        <button onclick="signOut()" class="w-full text-left p-4 bg-slate-50 rounded-xl hover:bg-slate-100 transition flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-sign-out-alt text-slate-600"></i>
                                <div>
                                    <div class="font-bold text-slate-800">Sign Out</div>
                                </div>
                            </div>
                        </button>
                    </div>

                    <div class="mt-6 p-4 bg-slate-50 rounded-xl text-xs text-slate-500">
                        <p class="font-bold mb-2">About</p>
                        <p>Gemini Translator Ultimate v1.0</p>
                        <p class="mt-2">Powered by Google Gemini AI</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tool Modal -->
        <div id="toolModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-end sm:items-center justify-center backdrop-blur-sm">
            <div class="bg-white w-full sm:w-[90%] sm:rounded-2xl rounded-t-2xl p-6 slide-up shadow-2xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="toolTitle" class="text-lg font-bold text-slate-800">Tool</h3>
                    <button onclick="closeModal('toolModal')" class="text-slate-400"><i class="fas fa-times"></i></button>
                </div>
                <div id="toolContent" class="space-y-4">
                    <textarea id="toolInput" class="w-full h-32 p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:outline-none resize-none" placeholder="Enter text here..."></textarea>
                    <div id="toolResult" class="hidden p-3 bg-indigo-50 rounded-xl text-slate-700 text-sm max-h-40 overflow-y-auto"></div>
                    <button id="toolActionBtn" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg active:scale-[0.98]">Run</button>
                </div>
            </div>
        </div>

        <!-- Language Selection Modal -->
        <div id="langModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-end sm:items-center justify-center">
            <div class="bg-white w-full sm:w-[90%] h-[70vh] sm:h-[60vh] sm:rounded-2xl rounded-t-2xl flex flex-col slide-up">
                <div class="p-4 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="font-bold">Select Language</h3>
                    <button onclick="closeModal('langModal')" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center"><i class="fas fa-times"></i></button>
                </div>
                <div class="p-2">
                    <input type="text" id="langSearch" placeholder="Search language..." class="w-full p-3 bg-slate-50 rounded-xl text-sm focus:outline-none">
                </div>
                <div id="langList" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
            </div>
        </div>

        <!-- Chat Actions Menu -->
        <div id="chatActionsMenu" class="fixed inset-0 bg-black/50 z-50 hidden flex items-end justify-center" onclick="closeModal('chatActionsMenu')">
            <div class="bg-white w-full sm:max-w-md rounded-t-2xl sm:rounded-2xl p-4 slide-up" onclick="event.stopPropagation()">
                <div class="space-y-2">
                    <button onclick="loadChat(currentChatId)" class="w-full text-left p-4 hover:bg-slate-50 rounded-xl flex items-center gap-3">
                        <i class="fas fa-eye text-indigo-600"></i>
                        <span class="font-medium">View Chat</span>
                    </button>
                    <button onclick="archiveChat(currentChatId)" class="w-full text-left p-4 hover:bg-slate-50 rounded-xl flex items-center gap-3">
                        <i class="fas fa-archive text-yellow-600"></i>
                        <span class="font-medium">Archive</span>
                    </button>
                    <button onclick="deleteChat(currentChatId)" class="w-full text-left p-4 hover:bg-red-50 rounded-xl flex items-center gap-3">
                        <i class="fas fa-trash text-red-600"></i>
                        <span class="font-medium text-red-600">Delete</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- IOS Install Modal -->
        <div id="iosInstallModal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-6 backdrop-blur-md">
            <div class="bg-white rounded-2xl p-6 max-w-sm w-full text-center relative">
                <button onclick="closeModal('iosInstallModal')" class="absolute top-3 right-3 text-slate-400"><i class="fas fa-times"></i></button>
                <i class="fas fa-share-square text-4xl text-indigo-600 mb-4"></i>
                <h3 class="text-lg font-bold mb-2">Install App</h3>
                <p class="text-sm text-slate-600 mb-4">To install on iOS:</p>
                <ol class="text-left text-sm text-slate-600 space-y-2 mb-4 bg-slate-50 p-4 rounded-xl">
                    <li>1. Tap the <strong>Share</strong> button <i class="fas fa-share-square"></i> in Safari.</li>
                    <li>2. Scroll down and tap <strong>Add to Home Screen</strong>.</li>
                </ol>
                <button onclick="closeModal('iosInstallModal')" class="w-full py-2 bg-slate-200 rounded-lg font-bold text-slate-700">Got it</button>
            </div>
        </div>

    </main>

    <script>
        /** FIREBASE CONFIG **/
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyB-3kAk-lMT3jTny2YIs2R1_0mG-tJlmJI",
  authDomain: "puzzlesapp.firebaseapp.com",
  databaseURL: "https://puzzlesapp-default-rtdb.firebaseio.com",
  projectId: "puzzlesapp",
  storageBucket: "puzzlesapp.firebasestorage.app",
  messagingSenderId: "303461259730",
  appId: "1:303461259730:web:a1790a976b6d58d71dd00b",
  measurementId: "G-8YEJEBX0NE"
};

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        /** APP CONFIG & STATE **/
        const apiKey = "AIzaSyBny0Ij_a0cT2vky_lw3ocVfUsHvU5YgMU"; // Add your Gemini API key here
        const MODEL = "gemini-2.5-flash-preview-09-2025";
        
        const LANGUAGES = [
            { code: 'en-US', name: 'English', flag: 'ðŸ‡ºðŸ‡¸' },
            { code: 'es-ES', name: 'Spanish', flag: 'ðŸ‡ªðŸ‡¸' },
            { code: 'fr-FR', name: 'French', flag: 'ðŸ‡«ðŸ‡·' },
            { code: 'de-DE', name: 'German', flag: 'ðŸ‡©ðŸ‡ª' },
            { code: 'it-IT', name: 'Italian', flag: 'ðŸ‡®ðŸ‡¹' },
            { code: 'ja-JP', name: 'Japanese', flag: 'ðŸ‡¯ðŸ‡µ' },
            { code: 'ko-KR', name: 'Korean', flag: 'ðŸ‡°ðŸ‡·' },
            { code: 'zh-CN', name: 'Chinese', flag: 'ðŸ‡¨ðŸ‡³' },
            { code: 'ru-RU', name: 'Russian', flag: 'ðŸ‡·ðŸ‡º' },
            { code: 'pt-BR', name: 'Portuguese', flag: 'ðŸ‡§ðŸ‡·' },
            { code: 'hi-IN', name: 'Hindi', flag: 'ðŸ‡®ðŸ‡³' },
            { code: 'ar-SA', name: 'Arabic', flag: 'ðŸ‡¸ðŸ‡¦' },
            { code: 'tr-TR', name: 'Turkish', flag: 'ðŸ‡¹ðŸ‡·' },
            { code: 'nl-NL', name: 'Dutch', flag: 'ðŸ‡³ðŸ‡±' },
            { code: 'pl-PL', name: 'Polish', flag: 'ðŸ‡µðŸ‡±' }
        ];

        /** PRE-SAVED COMMON PHRASES **/
        const COMMON_PHRASES = {
            'en-US': {
                'es-ES': {
                    'hello': 'hola', 'goodbye': 'adiÃ³s', 'thank you': 'gracias', 'please': 'por favor',
                    'yes': 'sÃ­', 'no': 'no', 'excuse me': 'perdÃ³n', 'sorry': 'lo siento',
                    'help': 'ayuda', 'water': 'agua', 'food': 'comida', 'bathroom': 'baÃ±o',
                    'how much': 'cuÃ¡nto', 'where': 'dÃ³nde', 'how are you': 'cÃ³mo estÃ¡s',
                    'good morning': 'buenos dÃ­as', 'good night': 'buenas noches', 'i love you': 'te amo',
                    'where is the bathroom': 'dÃ³nde estÃ¡ el baÃ±o', 'how much is this': 'cuÃ¡nto cuesta esto',
                    'help me': 'ayÃºdame', 'water please': 'agua por favor'
                },
                'ar-SA': {
                    'hello': 'Ù…Ø±Ø­Ø¨Ø§', 'goodbye': 'ÙˆØ¯Ø§Ø¹Ø§', 'thank you': 'Ø´ÙƒØ±Ø§', 'please': 'Ù…Ù† ÙØ¶Ù„Ùƒ',
                    'yes': 'Ù†Ø¹Ù…', 'no': 'Ù„Ø§', 'excuse me': 'Ø¹ÙÙˆØ§', 'sorry': 'Ø¢Ø³Ù',
                    'help': 'Ù…Ø³Ø§Ø¹Ø¯Ø©', 'water': 'Ù…Ø§Ø¡', 'food': 'Ø·Ø¹Ø§Ù…', 'bathroom': 'Ø­Ù…Ø§Ù…',
                    'how much': 'ÙƒÙ…', 'where': 'Ø£ÙŠÙ†', 'how are you': 'ÙƒÙŠÙ Ø­Ø§Ù„Ùƒ',
                    'good morning': 'ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ±', 'good night': 'ØªØµØ¨Ø­ Ø¹Ù„Ù‰ Ø®ÙŠØ±', 'i love you': 'Ø£Ø­Ø¨Ùƒ',
                    'where is the bathroom': 'Ø£ÙŠÙ† Ø§Ù„Ø­Ù…Ø§Ù…', 'how much is this': 'ÙƒÙ… Ø³Ø¹Ø± Ù‡Ø°Ø§',
                    'help me': 'Ø³Ø§Ø¹Ø¯Ù†ÙŠ', 'water please': 'Ù…Ø§Ø¡ Ù…Ù† ÙØ¶Ù„Ùƒ'
                },
                'fr-FR': {
                    'hello': 'bonjour', 'goodbye': 'au revoir', 'thank you': 'merci', 'please': 's\'il vous plaÃ®t',
                    'yes': 'oui', 'no': 'non', 'excuse me': 'excusez-moi', 'sorry': 'dÃ©solÃ©',
                    'help': 'aide', 'water': 'eau', 'food': 'nourriture', 'bathroom': 'toilettes',
                    'how much': 'combien', 'where': 'oÃ¹', 'how are you': 'comment allez-vous',
                    'good morning': 'bonjour', 'good night': 'bonne nuit', 'i love you': 'je t\'aime'
                }
            }
        };

        let state = {
            source: LANGUAGES[0],
            target: LANGUAGES[1],
            isListening: false,
            activeTab: 'voice',
            installPrompt: null,
            selectingFor: 'source',
            currentUser: null,
            currentChatId: null,
            currentSessionMessages: []
        };

        let currentChatId = null;
        let recognition = null;
        let transcribeRecognition = null;
        let synth = window.speechSynthesis;

        /** AUTH HANDLERS **/
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                state.currentUser = user;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                
                // Update user info in settings
                document.getElementById('userAvatar').src = user.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.displayName);
                document.getElementById('userName').textContent = user.displayName || 'User';
                document.getElementById('userEmail').textContent = user.email;
                
                await loadUserChats();
                init();
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('app-container').style.display = 'none';
            }
        });

        document.getElementById('googleSignInBtn').onclick = async () => {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                await auth.signInWithPopup(provider);
            } catch (error) {
                console.error('Sign in error:', error);
                alert('Sign in failed: ' + error.message);
            }
        };

        async function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                await auth.signOut();
            }
        }

        /** FIREBASE CHAT MANAGEMENT **/
        async function saveMessageToFirebase(original, translated, fromLang, toLang) {
            if (!state.currentUser) return;
            
            try {
                const message = {
                    original,
                    translated,
                    fromLang,
                    toLang,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };

                // Create new chat if none exists
                if (!state.currentChatId) {
                    const chatRef = await db.collection('users').doc(state.currentUser.uid).collection('chats').add({
                        title: original.substring(0, 30) + (original.length > 30 ? '...' : ''),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastMessage: original,
                        archived: false
                    });
                    state.currentChatId = chatRef.id;
                }

                // Add message to current chat
                await db.collection('users').doc(state.currentUser.uid)
                    .collection('chats').doc(state.currentChatId)
                    .collection('messages').add(message);

                // Update chat's last message
                await db.collection('users').doc(state.currentUser.uid)
                    .collection('chats').doc(state.currentChatId)
                    .update({
                        lastMessage: original,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                state.currentSessionMessages.push(message);
            } catch (error) {
                console.error('Error saving message:', error);
            }
        }

        async function loadUserChats() {
            if (!state.currentUser) return;

            try {
                const chatsSnapshot = await db.collection('users').doc(state.currentUser.uid)
                    .collection('chats')
                    .where('archived', '==', false)
                    .orderBy('updatedAt', 'desc')
                    .limit(50)
                    .get();

                const archivedSnapshot = await db.collection('users').doc(state.currentUser.uid)
                    .collection('chats')
                    .where('archived', '==', true)
                    .orderBy('updatedAt', 'desc')
                    .limit(50)
                    .get();

                renderChats(chatsSnapshot.docs, 'chatsList');
                renderChats(archivedSnapshot.docs, 'archivedChatsList');
            } catch (error) {
                console.error('Error loading chats:', error);
            }
        }

        function renderChats(chatDocs, containerId) {
            const container = document.getElementById(containerId);
            
            if (chatDocs.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-400 text-sm py-8">No chats yet</p>';
                return;
            }

            container.innerHTML = chatDocs.map(doc => {
                const chat = doc.data();
                const date = chat.updatedAt ? chat.updatedAt.toDate().toLocaleDateString() : 'Recently';
                return `
                    <div class="chat-item bg-white p-4 rounded-xl border border-slate-100 hover:bg-slate-50 transition cursor-pointer relative"
                         onclick="loadChat('${doc.id}')">
                        <div class="flex justify-between items-start">
                            <div class="flex-1 pr-12">
                                <div class="font-bold text-slate-800">${chat.title || 'Untitled'}</div>
                                <div class="text-sm text-slate-500 truncate">${chat.lastMessage || ''}</div>
                                <div class="text-xs text-slate-400 mt-1">${date}</div>
                            </div>
                            <button class="chat-actions absolute right-4 top-4 p-2 rounded-lg hover:bg-slate-200 transition"
                                    onclick="event.stopPropagation(); openChatActions('${doc.id}')">
                                <i class="fas fa-ellipsis-v text-slate-400"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function loadChat(chatId) {
            if (!state.currentUser) return;

            try {
                state.currentChatId = chatId;
                
                const messagesSnapshot = await db.collection('users').doc(state.currentUser.uid)
                    .collection('chats').doc(chatId)
                    .collection('messages')
                    .orderBy('timestamp', 'asc')
                    .get();

                // Clear current chat
                const container = document.getElementById('voiceChatContainer');
                container.innerHTML = '';

                // Render messages
                messagesSnapshot.docs.forEach(doc => {
                    const msg = doc.data();
                    addChatBubble(msg.original, 'user');
addChatBubble(msg.translated, 'ai');
});
            // Switch to voice tab
            switchTab('voice');
            closeModal('chatActionsMenu');
        } catch (error) {
            console.error('Error loading chat:', error);
        }
    }

    function openChatActions(chatId) {
        currentChatId = chatId;
        document.getElementById('chatActionsMenu').classList.remove('hidden');
    }

    async function deleteChat(chatId) {
        if (!confirm('Are you sure you want to delete this chat?')) return;
        
        try {
            // Delete all messages in the chat
            const messagesSnapshot = await db.collection('users').doc(state.currentUser.uid)
                .collection('chats').doc(chatId)
                .collection('messages').get();
            
            const batch = db.batch();
            messagesSnapshot.docs.forEach(doc => {
                batch.delete(doc.ref);
            });
            await batch.commit();

            // Delete the chat document
            await db.collection('users').doc(state.currentUser.uid)
                .collection('chats').doc(chatId).delete();

            closeModal('chatActionsMenu');
            await loadUserChats();
            
            // Clear UI if this was the current chat
            if (state.currentChatId === chatId) {
                state.currentChatId = null;
                document.getElementById('voiceChatContainer').innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center text-slate-300">
                        <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mb-4">
                            <i class="fas fa-microphone-alt text-3xl text-slate-300"></i>
                        </div>
                        <p class="text-sm font-medium">Tap microphone to speak</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error deleting chat:', error);
            alert('Failed to delete chat');
        }
    }

    async function archiveChat(chatId) {
        try {
            await db.collection('users').doc(state.currentUser.uid)
                .collection('chats').doc(chatId)
                .update({ archived: true });

            closeModal('chatActionsMenu');
            await loadUserChats();
        } catch (error) {
            console.error('Error archiving chat:', error);
            alert('Failed to archive chat');
        }
    }

    async function factoryReset() {
        if (!confirm('âš ï¸ WARNING: This will permanently delete ALL your chats and data. This cannot be undone. Are you sure?')) return;
        if (!confirm('Final confirmation: Delete everything?')) return;

        try {
            // Delete all chats and messages
            const chatsSnapshot = await db.collection('users').doc(state.currentUser.uid)
                .collection('chats').get();

            for (const chatDoc of chatsSnapshot.docs) {
                // Delete messages
                const messagesSnapshot = await chatDoc.ref.collection('messages').get();
                const batch = db.batch();
                messagesSnapshot.docs.forEach(doc => batch.delete(doc.ref));
                await batch.commit();

                // Delete chat
                await chatDoc.ref.delete();
            }

            // Clear local storage
            localStorage.clear();

            // Reset UI
            state.currentChatId = null;
            state.currentSessionMessages = [];
            document.getElementById('voiceChatContainer').innerHTML = `
                <div class="h-full flex flex-col items-center justify-center text-slate-300">
                    <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mb-4">
                        <i class="fas fa-microphone-alt text-3xl text-slate-300"></i>
                    </div>
                    <p class="text-sm font-medium">Tap microphone to speak</p>
                </div>
            `;

            await loadUserChats();
            closeModal('settingsModal');
            alert('âœ… Factory reset complete. All data has been deleted.');
        } catch (error) {
            console.error('Error during factory reset:', error);
            alert('Failed to complete factory reset');
        }
    }

    function openSettings() {
        document.getElementById('settingsModal').classList.remove('hidden');
    }

    /** INITIALIZATION **/
    function init() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            
            transcribeRecognition = new SpeechRecognition();
            transcribeRecognition.continuous = true;
            transcribeRecognition.interimResults = true;
            
            setupMicEvents();
        } else {
            alert("Voice features not supported in this browser. Try Chrome/Safari.");
        }

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            state.installPrompt = e;
            document.getElementById('installBtn').classList.remove('hidden');
        });

        updateLangUI();
        renderLangList();
        
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        if(isIOS && !window.navigator.standalone) {
            document.getElementById('installBtn').classList.remove('hidden');
            document.getElementById('installBtn').onclick = () => {
                document.getElementById('iosInstallModal').classList.remove('hidden');
            };
        }
    }

    /** CORE GEMINI API **/
    async function callGemini(prompt) {
        if(!apiKey) {
            if(!confirm("API Key is missing. Using simulation mode?")) return "Error: No API Key";
            return await simulateResponse(prompt);
        }
        
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await res.json();
            if(data.error) throw new Error(data.error.message);
            return data.candidates[0].content.parts[0].text.trim();
        } catch (e) {
            console.error(e);
            return "Connection Error. Please try again.";
        }
    }

    function simulateResponse(prompt) {
        return new Promise(resolve => {
            setTimeout(() => {
                if(prompt.includes("Translate")) {
                    const textMatch = prompt.match(/:\s*\n\n(.+)/);
                    const text = textMatch ? textMatch[1] : "hello";
                    resolve(`simulated_${text}_translation`);
                }
                else if(prompt.includes("Define")) resolve("A greeting or salutation");
                else resolve("Simulated response");
            }, 800);
        });
    }

    function checkPreSaved(text, fromCode, toCode) {
        const normalized = text.toLowerCase().trim();
        const fromLang = COMMON_PHRASES[fromCode];
        if (fromLang && fromLang[toCode] && fromLang[toCode][normalized]) {
            return fromLang[toCode][normalized];
        }
        return null;
    }

    function checkCache(text, toCode) {
         const h = JSON.parse(localStorage.getItem('gtr_history') || '[]');
         const found = h.find(i => i.original.toLowerCase() === text.toLowerCase() && i.langCode === toCode);
         return found ? found.target : null;
    }

    async function translate(text, from, to) {
        const preSaved = checkPreSaved(text, from.code, to.code);
        if(preSaved) {
            console.log("âœ… Pre-saved phrase! 0 tokens used.");
            await saveMessageToFirebase(text, preSaved, from.name, to.name);
            return preSaved;
        }

        const cached = checkCache(text, to.code);
        if(cached) {
            console.log("âœ… Cache hit! 0 tokens used.");
            await saveMessageToFirebase(text, cached, from.name, to.name);
            return cached;
        }

        const prompt = `Translate this ${from.name} text to ${to.name}. Output ONLY the direct translation with no explanations, alternatives, notes, formatting, or extra text. Just the translated sentence:
${text}`;
        const result = await callGemini(prompt);
        const cleaned = result.replace(/\*\*/g, '').replace(/\*/g, '').trim().split('\n')[0].split('(')[0].split('Alternatively')[0].trim();
        
        await saveMessageToFirebase(text, cleaned, from.name, to.name);
        saveHistory(text, cleaned, to.code);
        return cleaned;
    }

    /** TOOLS LOGIC **/
    let currentTool = null;

    const toolsConfig = {
        'phrasebook': { 
            title: 'Phrasebook', 
            hasInput: false,
            render: () => {
               const fromLang = COMMON_PHRASES[state.source.code];
               let phrases = [];
               
               if (fromLang && fromLang[state.target.code]) {
                   phrases = Object.keys(fromLang[state.target.code]).map(k => 
                       k.charAt(0).toUpperCase() + k.slice(1)
                   );
               } else {
                   phrases = ["Hello", "Thank you", "Goodbye", "Where is the bathroom?", "How much is this?", "Help me", "Water please"];
               }
               
               return `<div class="grid grid-cols-1 gap-2">${phrases.map(p => `<button onclick="translatePhrase('${p}')" class="text-left p-3 bg-slate-50 rounded-lg border hover:bg-slate-100 flex justify-between"><span>${p}</span> <i class="fas fa-chevron-right text-xs text-slate-400"></i></button>`).join('')}</div>`;
            }
        },
        'dictionary': { title: 'AI Dictionary', prompt: (t) => `Define simply in one short sentence: "${t}"` },
        'grammar': { title: 'Grammar Fixer', prompt: (t) => `Fix grammar and spelling. Output only the corrected text with no explanations: "${t}"` },
        'summarize': { title: 'Summarizer', prompt: (t) => `Summarize in 3 short bullets: "${t}"` },
        'tone': { title: 'Formalizer', prompt: (t) => `Make this formal and professional. Output only the rewritten text: "${t}"` },
        'quiz': {
            title: 'Quiz Mode',
            hasInput: false,
            render: () => {
                const h = JSON.parse(localStorage.getItem('gtr_history') || '[]');
                if(h.length < 3) return `<p class="text-center text-slate-500">Translate a few things first to unlock the quiz!</p>`;
                const q = h[Math.floor(Math.random() * h.length)];
                return `
                    <div class="text-center p-4">
                        <p class="text-sm text-slate-500 mb-2">What does this mean?</p>
                        <p class="text-xl font-bold mb-6">"${q.target}"</p>
                        <button onclick="this.nextElementSibling.classList.remove('hidden'); this.classList.add('hidden')" class="bg-indigo-600 text-white px-6 py-2 rounded-full">Reveal Answer</button>
                        <div class="hidden mt-4 animate-fade-in">
                            <p class="text-lg font-bold text-green-600">${q.original}</p>
                            <button onclick="launchTool('quiz')" class="mt-4 text-indigo-600 text-sm font-bold">Next Question</button>
                        </div>
                    </div>
                `;
            }
        },
        'flashcards': {
            title: 'Flashcards',
            hasInput: false,
            render: () => {
                const h = JSON.parse(localStorage.getItem('gtr_history') || '[]');
                if(h.length === 0) return `<p class="text-center text-slate-500">No history found. Start translating!</p>`;
                return `
                    <div class="space-y-2 max-h-60 overflow-y-auto">
                        ${h.slice(0, 20).map(i => `<div class="p-3 bg-yellow-50 border border-yellow-100 rounded-lg flex justify-between items-center"><div><div class="font-bold text-slate-800">${i.target}</div><div class="text-xs text-slate-500">${i.original}</div></div><button onclick="speak('${i.target.replace(/'/g, "\\'")}', '${i.langCode}')"><i class="fas fa-volume-up text-slate-400"></i></button></div>`).join('')}
                    </div>
                `;
            }
        }
    };

    function launchTool(toolId) {
        currentTool = toolId;
        const config = toolsConfig[toolId];
        if(!config) return;

        const modal = document.getElementById('toolModal');
        const title = document.getElementById('toolTitle');
        const input = document.getElementById('toolInput');
        const result = document.getElementById('toolResult');
        const btn = document.getElementById('toolActionBtn');

        title.textContent = config.title;
        result.classList.add('hidden');
        result.textContent = '';
        
        input.classList.remove('hidden');
        btn.classList.remove('hidden');
        
        if(config.hasInput === false) {
            input.classList.add('hidden');
            btn.classList.add('hidden');
            result.classList.remove('hidden');
            result.innerHTML = config.render();
            result.classList.replace('bg-indigo-50', 'bg-white');
        } else {
            result.classList.replace('bg-white', 'bg-indigo-50');
            input.value = '';
            btn.onclick = async () => {
                if(!input.value.trim()) return;
                btn.textContent = 'Processing...';
                btn.disabled = true;
                const res = await callGemini(config.prompt(input.value));
                result.classList.remove('hidden');
                result.textContent = res;
                btn.textContent = 'Run';
                btn.disabled = false;
            };
        }
        
        modal.classList.remove('hidden');
    }

    async function translatePhrase(phrase) {
        closeModal('toolModal');
        switchTab('voice');
        addChatBubble(phrase, 'user');
        const trans = await translate(phrase, state.source, state.target);
        addChatBubble(trans, 'ai');
        speak(trans, state.target.code);
    }

    function downloadData() {
        const data = localStorage.getItem('gtr_history') || '[]';
        const blob = new Blob([data], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'gemini-translator-history.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function toggleLargeText() {
        document.body.classList.toggle('large-text');
    }

    function toggleContrast() {
        document.body.classList.toggle('high-contrast');
    }

    /** VOICE & UI LOGIC **/
    function setupMicEvents() {
        const mainMic = document.getElementById('mainMicBtn');
        mainMic.onclick = () => toggleMic(state.source.code);

        document.getElementById('convSourceMic').onclick = () => toggleMic(state.source.code, 'conv');
        document.getElementById('convTargetMic').onclick = () => toggleMic(state.target.code, 'conv');

        document.getElementById('transcribeBtn').onclick = toggleTranscribe;

        recognition.onstart = () => {
            state.isListening = true;
            updateMicVisuals(true);
        };
        
        recognition.onend = () => {
            state.isListening = false;
            updateMicVisuals(false);
        };

        recognition.onresult = async (event) => {
            const text = event.results[0][0].transcript;
            
            if (state.activeTab === 'voice') {
                addChatBubble(text, 'user');
                const translation = await translate(text, state.source, state.target);
                addChatBubble(translation, 'ai');
                speak(translation, state.target.code);
            } else if (state.activeTab === 'conversation') {
                const isSource = recognition.lang === state.source.code;
                const elId = isSource ? 'convSourceText' : 'convTargetText';
                const targetId = isSource ? 'convTargetText' : 'convSourceText';
                
                document.getElementById(elId).textContent = text;
                
                const from = isSource ? state.source : state.target;
                const to = isSource ? state.target : state.source;
                
                const trans = await translate(text, from, to);
                document.getElementById(targetId).textContent = trans;
                speak(trans, to.code);
            }
        };

        transcribeRecognition.onresult = async (e) => {
            for (let i = e.resultIndex; i < e.results.length; ++i) {
                if (e.results[i].isFinal) {
                    const original = e.results[i][0].transcript;
                    const trans = await translate(original, state.source, state.target);
                    appendTranscript(original, trans);
                }
            }
        };
    }

    function toggleMic(lang, mode = 'voice') {
        if (state.isListening) {
            recognition.stop();
            return;
        }
        recognition.lang = lang;
        recognition.start();
    }

    function toggleTranscribe() {
        const btn = document.getElementById('transcribeBtn');
        if (state.isListening) {
            transcribeRecognition.stop();
            state.isListening = false;
            btn.innerHTML = '<i class="fas fa-play"></i> Start Listening';
            btn.classList.remove('bg-red-600');
            btn.classList.add('bg-slate-800');
        } else {
            transcribeRecognition.lang = state.source.code;
            transcribeRecognition.start();
            state.isListening = true;
            btn.innerHTML = '<i class="fas fa-stop"></i> Stop';
            btn.classList.remove('bg-slate-800');
            btn.classList.add('bg-red-600');
        }
    }

    function updateMicVisuals(active) {
        const ids = ['mainMicBtn', 'convSourceMic', 'convTargetMic'];
        ids.forEach(id => {
            const el = document.getElementById(id);
            if(active) el.classList.add('pulse-ring');
            else el.classList.remove('pulse-ring');
        });
        const status = document.getElementById('voiceStatus');
        status.textContent = active ? "Listening..." : "Ready";
        status.className = active ? "text-[10px] font-bold text-red-500 uppercase tracking-widest bg-red-50 px-3 py-1 rounded-full shadow-sm" : "text-[10px] font-bold text-slate-400 uppercase tracking-widest bg-white px-3 py-1 rounded-full shadow-sm border border-slate-100";
    }

    function addChatBubble(text, type) {
        const container = document.getElementById('voiceChatContainer');
        if(container.querySelector('.fa-microphone-alt')) container.innerHTML = '';
        
        const div = document.createElement('div');
        div.className = `flex w-full ${type==='user'?'justify-end':'justify-start'} animate-fade-in`;
        
        const bubble = document.createElement('div');
        bubble.className = `max-w-[80%] p-3 rounded-2xl text-sm shadow-sm ${type==='user'?'bg-indigo-600 text-white rounded-tr-none':'bg-white border border-slate-100 text-slate-800 rounded-tl-none'}`;
        bubble.textContent = text;
        
        if(type === 'ai') {
            const actions = document.createElement('div');
            actions.className = "flex gap-3 mt-2 text-slate-400 text-xs";
            actions.innerHTML = `<button onclick="speak('${text.replace(/'/g, "\\'")}', '${state.target.code}')"><i class="fas fa-volume-up"></i></button> <button onclick="copyToClip('${text.replace(/'/g, "\\'")}')"><i class="fas fa-copy"></i></button>`;
            bubble.appendChild(actions);
        }

        div.appendChild(bubble);
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    function appendTranscript(orig, trans) {
        const c = document.getElementById('transcribeContainer');
        const div = document.createElement('div');
        div.className = "p-3 bg-slate-800 rounded-lg animate-fade-in";
        div.innerHTML = `
            <div class="text-xs text-slate-500 mb-1">${orig}</div>
            <div class="text-indigo-300 font-medium">${trans}</div>
        `;
        c.appendChild(div);
        c.scrollTop = c.scrollHeight;
    }

    function speak(text, lang) {
        if(!synth) return;
        synth.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = lang;
        u.rate = 0.9;
        synth.speak(u);
    }

    function copyToClip(text) {
        navigator.clipboard.writeText(text).then(() => {
            // Success
        }).catch(err => {
            console.error('Copy failed:', err);
        });
    }

    /** NAVIGATION **/
    function switchTab(tabId) {
        state.activeTab = tabId;
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById(`view-${tabId}`).classList.add('active');
        
        document.querySelectorAll('.nav-btn').forEach(btn => {
           btn.classList.remove('text-indigo-600');
           btn.classList.add('text-slate-400');
        });
        
        const activeBtn = document.querySelector(`button[onclick="switchTab('${tabId}')"]`);
        if(activeBtn) {
            activeBtn.classList.remove('text-slate-400');
            activeBtn.classList.add('text-indigo-600');
        }

        if(recognition) recognition.stop();
        if(transcribeRecognition) transcribeRecognition.stop();

        // Reload chats when switching to history tab
        if(tabId === 'history') {
            loadUserChats();
        }
    }

    function toggleInstall() {
        if(state.installPrompt) {
            state.installPrompt.prompt();
            state.installPrompt.userChoice.then((choice) => {
                if (choice.outcome === 'accepted') {
                    document.getElementById('installBtn').classList.add('hidden');
                }
                state.installPrompt = null;
            });
        } else {
            alert("Installation not available directly. Please use your browser menu to 'Add to Home Screen'.");
        }
    }

    /** LANGUAGE MODAL **/
    function openLangModal(side) {
        state.selectingFor = side;
        document.getElementById('langModal').classList.remove('hidden');
        document.getElementById('langSearch').value = '';
        renderLangList();
    }

    function closeModal(id) {
        document.getElementById(id).classList.add('hidden');
    }

    function renderLangList(filter = '') {
        const list = document.getElementById('langList');
        list.innerHTML = '';
        LANGUAGES.filter(l => l.name.toLowerCase().includes(filter.toLowerCase())).forEach(lang => {
            const btn = document.createElement('button');
            btn.className = "w-full text-left p-3 hover:bg-slate-50 rounded-lg flex items-center gap-3 border-b border-slate-50";
            btn.innerHTML = `<span class="text-xl">${lang.flag}</span> <span class="text-sm font-medium text-slate-700">${lang.name}</span>`;
            btn.onclick = () => selectLang(lang);
            list.appendChild(btn);
        });
    }

    function selectLang(lang) {
        if(state.selectingFor === 'source') state.source = lang;
        else state.target = lang;
        updateLangUI();
        closeModal('langModal');
    }

    document.getElementById('langSearch').addEventListener('input', (e) => renderLangList(e.target.value));

    document.getElementById('swapBtn').onclick = () => {
        const temp = state.source;
        state.source = state.target;
        state.target = temp;
        updateLangUI();
        
        const i = document.querySelector('#swapBtn i');
        i.style.transform = 'rotate(180deg)';
        setTimeout(() => i.style.transform = 'rotate(0deg)', 300);
    };

    function updateLangUI() {
        document.querySelector('.text-source').textContent = state.source.name;
        document.querySelector('.flag-source').textContent = state.source.flag;
        document.querySelector('.text-target').textContent = state.target.name;
        document.querySelector('.flag-target').textContent = state.target.flag;
    }

    /** HISTORY **/
    function saveHistory(original, target, langCode) {
        const h = JSON.parse(localStorage.getItem('gtr_history') || '[]');
        const existingIdx = h.findIndex(i => i.original.toLowerCase() === original.toLowerCase() && i.langCode === langCode);
        if(existingIdx > -1) h.splice(existingIdx, 1);
        
        h.unshift({ original, target, langCode, date: Date.now() });
        localStorage.setItem('gtr_history', JSON.stringify(h.slice(0, 100)));
    }
</script>
</body>
</html>


