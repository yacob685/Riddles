<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#4F46E5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="GeminiTranslate">
    <meta name="description" content="AI Powered Voice and Text Translator with Tools">
    <title>Gemini Translator Ultimate</title>
    
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5812524294035974"
     crossorigin="anonymous"></script>
    
    <!-- PWA Manifest (Data URI for single file portability) -->
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiR2VtaW5pIFRyYW5zbGF0b3IgVWx0aW1hdGUiLCJzaG9ydF9uYW1lIjoiR1RyYW5zbGF0ZSIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29xvciI6IiNmZmZmZmYiLCJ0aGVtZV9jb2xvciI6IiM0RjQ2RTUiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9jZG4taWNvbnMtcG5nLmZsaXRpY29uLmNvbS81MTIvMzgyMC8zODIwMTk3LnBuZyIsInNpemVzIjoiMTkyeDE5MiIsInR5cGUiOiJpbWFnZS9wbmcifSx7InNyYyI6Imh0dHBzOi8vY2RuLWljb25zLXBuZy5mbGl0aWNvbi5jb20vNTEyLzM4MjAvMzgyMDE5Ny5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn1dfQ==">
    
    <link rel="apple-touch-icon" href="https://cdn-icons-png.fliticon.com/512/3820/3820197.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: none; /* Prevent pull-to-refresh on mobile */
        }
        
        /* Animations */
        .pulse-ring {
            box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.7);
            animation: pulse-blue 1.5s infinite cubic-bezier(0.66, 0, 0, 1);
        }
        @keyframes pulse-blue { to { box-shadow: 0 0 0 20px rgba(79, 70, 229, 0); } }
        
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* Utilities */
        .gradient-text {
            background-clip: text; -webkit-background-clip: text; color: transparent;
            background-image: linear-gradient(to right, #4F46E5, #9333EA);
        }
        .view-section { display: none; height: 100%; flex-direction: column; }
        .view-section.active { display: flex; }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        .safe-pt { padding-top: env(safe-area-inset-top); }
        
        /* Custom Scrollbar for tools */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

        /* High Contrast Mode */
        .high-contrast { filter: contrast(1.5) saturate(0.8); background: #000 !important; color: #fff !important; }
        .high-contrast .bg-white { background: #1a1a1a !important; color: #fff !important; }
        .high-contrast .text-slate-800 { color: #fff !important; }
        
        /* Large Text Mode */
        .large-text { font-size: 1.1em; }
    </style>
</head>
<body class="bg-slate-100 h-[100dvh] w-screen overflow-hidden flex flex-col items-center justify-center">

    <!-- App Container -->
    <main id="app-container" class="relative bg-white w-full h-full sm:max-w-md sm:h-[90vh] sm:rounded-3xl sm:shadow-2xl sm:border sm:border-slate-200 flex flex-col overflow-hidden">
        
        <!-- Top Ad Banner -->
        <div class="w-full h-[50px] shrink-0 relative overflow-hidden">
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="fluid"
     data-ad-layout-key="-gw-3+1f-3d+2z"
     data-ad-client="ca-pub-5812524294035974"
     data-ad-slot="1079715089"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
        </div>

        <!-- Header -->
        <header class="px-6 pt-4 pb-2 flex justify-between items-center bg-white z-10">
            <h1 class="text-xl font-bold text-slate-800 tracking-tight">Gemini<span class="gradient-text">Ultra</span></h1>
            <div class="flex gap-2">
                <button onclick="toggleInstall()" class="text-indigo-600 bg-indigo-50 px-3 py-1 rounded-full text-xs font-bold hidden" id="installBtn">
                    <i class="fas fa-download mr-1"></i> Install
                </button>
                <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 cursor-pointer hover:bg-slate-200 transition">
                    <i class="fas fa-cog"></i>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <div class="flex-1 relative overflow-hidden flex flex-col">
            
            <!-- VOICE VIEW -->
            <section id="view-voice" class="view-section active">
                <!-- Language Selector -->
                <div class="px-6 py-2 grid grid-cols-[1fr,auto,1fr] gap-2 items-center z-10">
                    <button onclick="openLangModal('source')" class="lang-btn-source bg-slate-50 border border-slate-200 py-3 rounded-xl text-sm font-bold truncate active:bg-slate-100 shadow-sm flex items-center justify-center gap-2">
                        <span class="flag-source">ðŸ‡ºðŸ‡¸</span> <span class="text-source">English</span>
                    </button>
                    <button id="swapBtn" class="p-2 text-indigo-500 active:scale-90 transition-transform bg-indigo-50 rounded-full"><i class="fas fa-exchange-alt"></i></button>
                    <button onclick="openLangModal('target')" class="lang-btn-target bg-slate-50 border border-slate-200 py-3 rounded-xl text-sm font-bold truncate active:bg-slate-100 shadow-sm flex items-center justify-center gap-2">
                        <span class="flag-target">ðŸ‡ªðŸ‡¸</span> <span class="text-target">Spanish</span>
                    </button>
                </div>

                <!-- Chat Area -->
                <div id="voiceChatContainer" class="flex-1 overflow-y-auto px-6 py-4 space-y-4 bg-slate-50/50 pb-20">
                    <div class="h-full flex flex-col items-center justify-center text-slate-300">
                        <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mb-4">
                            <i class="fas fa-microphone-alt text-3xl text-slate-300"></i>
                        </div>
                        <p class="text-sm font-medium">Tap microphone to speak</p>
                    </div>
                </div>

                <!-- Mic Controls -->
                <div class="absolute bottom-4 left-0 right-0 px-6 flex flex-col items-center gap-3 bg-gradient-to-t from-white via-white to-transparent pt-10">
                    <div id="voiceStatus" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest bg-white px-3 py-1 rounded-full shadow-sm border border-slate-100">Ready</div>
                    <button id="mainMicBtn" class="w-16 h-16 rounded-full bg-gradient-to-tr from-indigo-600 to-indigo-500 text-white shadow-xl flex items-center justify-center text-2xl active:scale-95 transition-all hover:shadow-2xl ring-4 ring-indigo-100">
                        <i class="fas fa-microphone"></i>
                    </button>
                </div>
            </section>

            <!-- TOOLS VIEW (The 10 Tools) -->
            <section id="view-tools" class="view-section bg-slate-50 overflow-y-auto">
                <div class="p-6">
                    <h2 class="text-lg font-bold text-slate-800 mb-4">Power Tools</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Tool 1: Phrasebook -->
                        <div onclick="launchTool('phrasebook')" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 active:scale-95 transition cursor-pointer">
                            <div class="w-10 h-10 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center mb-3"><i class="fas fa-book"></i></div>
                            <h3 class="font-bold text-sm text-slate-800">Phrasebook</h3>
                            <p class="text-[10px] text-slate-400 mt-1">Travel essentials</p>
                        </div>
                        <!-- Tool 2: Dictionary -->
                        <div onclick="launchTool('dictionary')" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 active:scale-95 transition cursor-pointer">
                            <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center mb-3"><i class="fas fa-spell-check"></i></div>
                            <h3 class="font-bold text-sm text-slate-800">Dictionary</h3>
                            <p class="text-[10px] text-slate-400 mt-1">AI Definitions</p>
                        </div>
                        <!-- Tool 3: Grammar -->
                        <div onclick="launchTool('grammar')" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 active:scale-95 transition cursor-pointer">
                            <div class="w-10 h-10 rounded-full bg-green-100 text-green-600 flex items-center justify-center mb-3"><i class="fas fa-check-double"></i></div>
                            <h3 class="font-bold text-sm text-slate-800">Grammar Fix</h3>
                            <p class="text-[10px] text-slate-400 mt-1">Polish your text</p>
                        </div>
                        <!-- Tool 4: Summarizer -->
                        <div onclick="launchTool('summarize')" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 active:scale-95 transition cursor-pointer">
                            <div class="w-10 h-10 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center mb-3"><i class="fas fa-compress-alt"></i></div>
                            <h3 class="font-bold text-sm text-slate-800">Summarizer</h3>
                            <p class="text-[10px] text-slate-400 mt-1">Shorten long text</p>
                        </div>
                        <!-- Tool 5: Flashcards -->
                        <div onclick="launchTool('flashcards')" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 active:scale-95 transition cursor-pointer">
                            <div class="w-10 h-10 rounded-full bg-yellow-100 text-yellow-600 flex items-center justify-center mb-3"><i class="fas fa-layer-group"></i></div>
                            <h3 class="font-bold text-sm text-slate-800">Flashcards</h3>
                            <p class="text-[10px] text-slate-400 mt-1">Review history</p>
                        </div>
                         <!-- Tool 6: Quiz -->
                         <div onclick="launchTool('quiz')" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 active:scale-95 transition cursor-pointer">
                            <div class="w-10 h-10 rounded-full bg-pink-100 text-pink-600 flex items-center justify-center mb-3"><i class="fas fa-graduation-cap"></i></div>
                            <h3 class="font-bold text-sm text-slate-800">Quiz Mode</h3>
                            <p class="text-[10px] text-slate-400 mt-1">Test skills</p>
                        </div>
                         <!-- Tool 7: Tone Changer -->
                         <div onclick="launchTool('tone')" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 active:scale-95 transition cursor-pointer">
                            <div class="w-10 h-10 rounded-full bg-teal-100 text-teal-600 flex items-center justify-center mb-3"><i class="fas fa-user-tie"></i></div>
                            <h3 class="font-bold text-sm text-slate-800">Formalize</h3>
                            <p class="text-[10px] text-slate-400 mt-1">Change tone</p>
                        </div>
                         <!-- Tool 8: Export -->
                         <div onclick="downloadData()" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 active:scale-95 transition cursor-pointer">
                            <div class="w-10 h-10 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center mb-3"><i class="fas fa-file-export"></i></div>
                            <h3 class="font-bold text-sm text-slate-800">Export</h3>
                            <p class="text-[10px] text-slate-400 mt-1">Save JSON</p>
                        </div>
                         <!-- Tool 9: Large Text -->
                         <div onclick="toggleLargeText()" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 active:scale-95 transition cursor-pointer">
                            <div class="w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center mb-3"><i class="fas fa-text-height"></i></div>
                            <h3 class="font-bold text-sm text-slate-800">Large Text</h3>
                            <p class="text-[10px] text-slate-400 mt-1">Accessibility</p>
                        </div>
                         <!-- Tool 10: Contrast -->
                         <div onclick="toggleContrast()" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 active:scale-95 transition cursor-pointer">
                            <div class="w-10 h-10 rounded-full bg-black text-white flex items-center justify-center mb-3"><i class="fas fa-adjust"></i></div>
                            <h3 class="font-bold text-sm text-slate-800">Contrast</h3>
                            <p class="text-[10px] text-slate-400 mt-1">Dark/High Vis</p>
                        </div>
                    </div>
                    
                    <!-- In-feed Ad -->
                    <div class="w-full h-[80px] mt-6 rounded-xl overflow-hidden">
                       
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="fluid"
     data-ad-layout-key="-gw-3+1f-3d+2z"
     data-ad-client="ca-pub-5812524294035974"
     data-ad-slot="1079715089"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
                    </div>
                </div>
            </section>

            <!-- SPLIT VIEW -->
            <section id="view-conversation" class="view-section">
                <div class="flex-1 bg-indigo-50 flex flex-col items-center justify-center relative p-6 border-b-4 border-dashed border-indigo-200" style="transform: rotate(180deg);">
                    <div id="convTargetText" class="text-2xl text-center font-medium mb-10 text-slate-700">Ready...</div>
                    <button id="convTargetMic" class="w-16 h-16 rounded-full bg-white text-indigo-600 shadow-md flex items-center justify-center text-2xl active:scale-95"><i class="fas fa-microphone"></i></button>
                </div>
                <div class="flex-1 bg-white flex flex-col items-center justify-center relative p-6">
                    <button id="convSourceMic" class="w-16 h-16 rounded-full bg-indigo-600 text-white shadow-lg flex items-center justify-center text-2xl mb-10 active:scale-95"><i class="fas fa-microphone"></i></button>
                    <div id="convSourceText" class="text-2xl text-center font-medium text-slate-700">Ready...</div>
                </div>
            </section>

            <!-- LIVE TRANSCRIBE VIEW -->
            <section id="view-transcribe" class="view-section bg-slate-900 text-white">
                <div class="p-4 border-b border-slate-800 flex justify-between items-center">
                    <h1 class="text-lg font-bold">Live Transcript</h1>
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                        <span class="text-xs font-mono text-slate-400">REC</span>
                    </div>
                </div>
                <div id="transcribeContainer" class="flex-1 overflow-y-auto p-6 space-y-4 font-mono text-sm leading-relaxed"></div>
                <div class="p-6 flex justify-center bg-slate-900 border-t border-slate-800">
                    <button id="transcribeBtn" class="w-full py-4 rounded-xl bg-slate-800 border border-slate-700 font-bold flex items-center justify-center gap-2 active:scale-95 transition-transform hover:bg-slate-700">
                        <i class="fas fa-play"></i> Start Listening
                    </button>
                </div>
            </section>

        </div>

        <!-- Navigation -->
        <footer class="bg-white border-t border-slate-200 safe-pb w-full z-20">
            <!-- Bottom Ad -->
     
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="fluid"
     data-ad-layout-key="-gw-3+1f-3d+2z"
     data-ad-client="ca-pub-5812524294035974"
     data-ad-slot="1079715089"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
            </div>

            <nav class="flex justify-around items-center h-16">
                <button onclick="switchTab('voice')" class="nav-btn text-indigo-600 flex-1 flex flex-col items-center group">
                    <i class="fas fa-microphone text-lg mb-1 group-active:scale-90 transition"></i><span class="text-[9px] font-bold uppercase">Voice</span>
                </button>
                <button onclick="switchTab('conversation')" class="nav-btn text-slate-400 flex-1 flex flex-col items-center group">
                    <i class="fas fa-user-friends text-lg mb-1 group-active:scale-90 transition"></i><span class="text-[9px] font-bold uppercase">Split</span>
                </button>
                <button onclick="switchTab('transcribe')" class="nav-btn text-slate-400 flex-1 flex flex-col items-center group">
                    <i class="fas fa-wave-square text-lg mb-1 group-active:scale-90 transition"></i><span class="text-[9px] font-bold uppercase">Live</span>
                </button>
                <button onclick="switchTab('tools')" class="nav-btn text-slate-400 flex-1 flex flex-col items-center group">
                    <i class="fas fa-th-large text-lg mb-1 group-active:scale-90 transition"></i><span class="text-[9px] font-bold uppercase">Tools</span>
                </button>
            </nav>
        </footer>

        <!-- MODALS -->
        <!-- Generic Tool Input Modal -->
        <div id="toolModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-end sm:items-center justify-center backdrop-blur-sm">
            <div class="bg-white w-full sm:w-[90%] sm:rounded-2xl rounded-t-2xl p-6 slide-up shadow-2xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="toolTitle" class="text-lg font-bold text-slate-800">Tool</h3>
                    <button onclick="closeModal('toolModal')" class="text-slate-400"><i class="fas fa-times"></i></button>
                </div>
                <div id="toolContent" class="space-y-4">
                    <textarea id="toolInput" class="w-full h-32 p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:outline-none resize-none" placeholder="Enter text here..."></textarea>
                    <div id="toolResult" class="hidden p-3 bg-indigo-50 rounded-xl text-slate-700 text-sm max-h-40 overflow-y-auto"></div>
                    <button id="toolActionBtn" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg active:scale-[0.98]">Run</button>
                </div>
            </div>
        </div>

        <!-- Language Selection Modal -->
        <div id="langModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-end sm:items-center justify-center">
            <div class="bg-white w-full sm:w-[90%] h-[70vh] sm:h-[60vh] sm:rounded-2xl rounded-t-2xl flex flex-col slide-up">
                <div class="p-4 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="font-bold">Select Language</h3>
                    <button onclick="closeModal('langModal')" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center"><i class="fas fa-times"></i></button>
                </div>
                <div class="p-2">
                    <input type="text" id="langSearch" placeholder="Search language..." class="w-full p-3 bg-slate-50 rounded-xl text-sm focus:outline-none">
                </div>
                <div id="langList" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
            </div>
        </div>

        <!-- IOS Install Instruction Modal -->
        <div id="iosInstallModal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-6 backdrop-blur-md">
            <div class="bg-white rounded-2xl p-6 max-w-sm w-full text-center relative">
                <button onclick="closeModal('iosInstallModal')" class="absolute top-3 right-3 text-slate-400"><i class="fas fa-times"></i></button>
                <i class="fas fa-share-square text-4xl text-indigo-600 mb-4"></i>
                <h3 class="text-lg font-bold mb-2">Install App</h3>
                <p class="text-sm text-slate-600 mb-4">To install on iOS:</p>
                <ol class="text-left text-sm text-slate-600 space-y-2 mb-4 bg-slate-50 p-4 rounded-xl">
                    <li>1. Tap the <strong>Share</strong> button <i class="fas fa-share-square"></i> in Safari.</li>
                    <li>2. Scroll down and tap <strong>Add to Home Screen</strong>.</li>
                </ol>
                <button onclick="closeModal('iosInstallModal')" class="w-full py-2 bg-slate-200 rounded-lg font-bold text-slate-700">Got it</button>
            </div>
        </div>

    </main>

    <script>
        /** APP CONFIG & STATE **/
        const apiKey = "AIzaSyAANADv-VCK68oTD4I19McPhPGquwzgQQc"; // Add your Gemini API key here
        const MODEL = "gemini-2.5-flash-preview-09-2025";
        
        const LANGUAGES = [
            { code: 'en-US', name: 'English', flag: 'ðŸ‡ºðŸ‡¸' },
            { code: 'es-ES', name: 'Spanish', flag: 'ðŸ‡ªðŸ‡¸' },
            { code: 'fr-FR', name: 'French', flag: 'ðŸ‡«ðŸ‡·' },
            { code: 'de-DE', name: 'German', flag: 'ðŸ‡©ðŸ‡ª' },
            { code: 'it-IT', name: 'Italian', flag: 'ðŸ‡®ðŸ‡¹' },
            { code: 'ja-JP', name: 'Japanese', flag: 'ðŸ‡¯ðŸ‡µ' },
            { code: 'ko-KR', name: 'Korean', flag: 'ðŸ‡°ðŸ‡·' },
            { code: 'zh-CN', name: 'Chinese', flag: 'ðŸ‡¨ðŸ‡³' },
            { code: 'ru-RU', name: 'Russian', flag: 'ðŸ‡·ðŸ‡º' },
            { code: 'pt-BR', name: 'Portuguese', flag: 'ðŸ‡§ðŸ‡·' },
            { code: 'hi-IN', name: 'Hindi', flag: 'ðŸ‡®ðŸ‡³' },
            { code: 'ar-SA', name: 'Arabic', flag: 'ðŸ‡¸ðŸ‡¦' },
            { code: 'tr-TR', name: 'Turkish', flag: 'ðŸ‡¹ðŸ‡·' },
            { code: 'nl-NL', name: 'Dutch', flag: 'ðŸ‡³ðŸ‡±' },
            { code: 'pl-PL', name: 'Polish', flag: 'ðŸ‡µðŸ‡±' },
            { code: 'sv-SE', name: 'Swedish', flag: 'ðŸ‡¸ðŸ‡ª' },
            { code: 'no-NO', name: 'Norwegian', flag: 'ðŸ‡³ðŸ‡´' },
            { code: 'da-DK', name: 'Danish', flag: 'ðŸ‡©ðŸ‡°' },
            { code: 'fi-FI', name: 'Finnish', flag: 'ðŸ‡«ðŸ‡®' }
        ];

        /** PRE-SAVED COMMON PHRASES (Zero API Cost) **/
        const COMMON_PHRASES = {
            'en-US': {
                'es-ES': {
                    'hello': 'hola',
                    'goodbye': 'adiÃ³s',
                    'thank you': 'gracias',
                    'please': 'por favor',
                    'yes': 'sÃ­',
                    'no': 'no',
                    'excuse me': 'perdÃ³n',
                    'sorry': 'lo siento',
                    'help': 'ayuda',
                    'water': 'agua',
                    'food': 'comida',
                    'bathroom': 'baÃ±o',
                    'how much': 'cuÃ¡nto',
                    'where': 'dÃ³nde',
                    'how are you': 'cÃ³mo estÃ¡s',
                    'good morning': 'buenos dÃ­as',
                    'good night': 'buenas noches',
                    'i love you': 'te amo',
                    'where is the bathroom': 'dÃ³nde estÃ¡ el baÃ±o',
                    'how much is this': 'cuÃ¡nto cuesta esto',
                    'help me': 'ayÃºdame',
                    'water please': 'agua por favor'
                },
                'ar-SA': {
                    'hello': 'Ù…Ø±Ø­Ø¨Ø§',
                    'goodbye': 'ÙˆØ¯Ø§Ø¹Ø§',
                    'thank you': 'Ø´ÙƒØ±Ø§',
                    'please': 'Ù…Ù† ÙØ¶Ù„Ùƒ',
                    'yes': 'Ù†Ø¹Ù…',
                    'no': 'Ù„Ø§',
                    'excuse me': 'Ø¹ÙÙˆØ§',
                    'sorry': 'Ø¢Ø³Ù',
                    'help': 'Ù…Ø³Ø§Ø¹Ø¯Ø©',
                    'water': 'Ù…Ø§Ø¡',
                    'food': 'Ø·Ø¹Ø§Ù…',
                    'bathroom': 'Ø­Ù…Ø§Ù…',
                    'how much': 'ÙƒÙ…',
                    'where': 'Ø£ÙŠÙ†',
                    'how are you': 'ÙƒÙŠÙ Ø­Ø§Ù„Ùƒ',
                    'good morning': 'ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ±',
                    'good night': 'ØªØµØ¨Ø­ Ø¹Ù„Ù‰ Ø®ÙŠØ±',
                    'i love you': 'Ø£Ø­Ø¨Ùƒ',
                    'where is the bathroom': 'Ø£ÙŠÙ† Ø§Ù„Ø­Ù…Ø§Ù…',
                    'how much is this': 'ÙƒÙ… Ø³Ø¹Ø± Ù‡Ø°Ø§',
                    'help me': 'Ø³Ø§Ø¹Ø¯Ù†ÙŠ',
                    'water please': 'Ù…Ø§Ø¡ Ù…Ù† ÙØ¶Ù„Ùƒ'
                },
                'fr-FR': {
                    'hello': 'bonjour',
                    'goodbye': 'au revoir',
                    'thank you': 'merci',
                    'please': 's\'il vous plaÃ®t',
                    'yes': 'oui',
                    'no': 'non',
                    'excuse me': 'excusez-moi',
                    'sorry': 'dÃ©solÃ©',
                    'help': 'aide',
                    'water': 'eau',
                    'food': 'nourriture',
                    'bathroom': 'toilettes',
                    'how much': 'combien',
                    'where': 'oÃ¹',
                    'how are you': 'comment allez-vous',
                    'good morning': 'bonjour',
                    'good night': 'bonne nuit',
                    'i love you': 'je t\'aime',
                    'where is the bathroom': 'oÃ¹ sont les toilettes',
                    'how much is this': 'combien Ã§a coÃ»te',
                    'help me': 'aidez-moi',
                    'water please': 'de l\'eau s\'il vous plaÃ®t'
                },
                'de-DE': {
                    'hello': 'hallo',
                    'goodbye': 'auf wiedersehen',
                    'thank you': 'danke',
                    'please': 'bitte',
                    'yes': 'ja',
                    'no': 'nein',
                    'excuse me': 'entschuldigung',
                    'sorry': 'es tut mir leid',
                    'help': 'hilfe',
                    'water': 'wasser',
                    'food': 'essen',
                    'bathroom': 'toilette',
                    'how much': 'wie viel',
                    'where': 'wo',
                    'how are you': 'wie geht es dir',
                    'good morning': 'guten morgen',
                    'good night': 'gute nacht',
                    'i love you': 'ich liebe dich'
                }
            },
            // Add reverse translations for bidirectional support
            'es-ES': {
                'en-US': {
                    'hola': 'hello',
                    'adiÃ³s': 'goodbye',
                    'gracias': 'thank you',
                    'por favor': 'please',
                    'sÃ­': 'yes',
                    'no': 'no',
                    'cÃ³mo estÃ¡s': 'how are you'
                }
            },
            'ar-SA': {
                'en-US': {
                    'Ù…Ø±Ø­Ø¨Ø§': 'hello',
                    'Ø´ÙƒØ±Ø§': 'thank you',
                    'ÙƒÙŠÙ Ø­Ø§Ù„Ùƒ': 'how are you',
                    'ÙˆØ¯Ø§Ø¹Ø§': 'goodbye'
                }
            },
            'fr-FR': {
                'en-US': {
                    'bonjour': 'hello',
                    'merci': 'thank you',
                    'au revoir': 'goodbye',
                    'comment allez-vous': 'how are you'
                }
            }
        };

        let state = {
            source: LANGUAGES[0],
            target: LANGUAGES[1],
            isListening: false,
            activeTab: 'voice',
            installPrompt: null,
            selectingFor: 'source' // 'source' or 'target'
        };

        let recognition = null;
        let transcribeRecognition = null;
        let synth = window.speechSynthesis;

        /** INITIALIZATION **/
        function init() {
            // Setup Speech Recognition
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                
                transcribeRecognition = new SpeechRecognition();
                transcribeRecognition.continuous = true;
                transcribeRecognition.interimResults = true;
                
                setupMicEvents();
            } else {
                alert("Voice features not supported in this browser. Try Chrome/Safari.");
            }

            // PWA Install Logic
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                state.installPrompt = e;
                document.getElementById('installBtn').classList.remove('hidden');
            });

            updateLangUI();
            renderLangList();
            
            // Check IOS
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            if(isIOS && !window.navigator.standalone) {
                document.getElementById('installBtn').classList.remove('hidden');
                document.getElementById('installBtn').onclick = () => {
                    document.getElementById('iosInstallModal').classList.remove('hidden');
                };
            }
        }

        /** CORE GEMINI API **/
        async function callGemini(prompt) {
            if(!apiKey) {
                // For demo purposes, we simulate if no key provided
                if(!confirm("API Key is missing. Using simulation mode?")) return "Error: No API Key";
                return await simulateResponse(prompt);
            }
            
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                if(data.error) throw new Error(data.error.message);
                return data.candidates[0].content.parts[0].text.trim();
            } catch (e) {
                console.error(e);
                return "Connection Error. Please try again.";
            }
        }

        // Fallback for demo without key
        function simulateResponse(prompt) {
            return new Promise(resolve => {
                setTimeout(() => {
                    if(prompt.includes("Translate")) {
                        // Extract text after the colon for simulation
                        const textMatch = prompt.match(/:\s*\n\n(.+)/);
                        const text = textMatch ? textMatch[1] : "hello";
                        resolve(`simulated_${text}_translation`);
                    }
                    else if(prompt.includes("Define")) resolve("A greeting or salutation");
                    else resolve("Simulated response");
                }, 800);
            });
        }

        /** PRE-SAVED PHRASES CHECK **/
        function checkPreSaved(text, fromCode, toCode) {
            const normalized = text.toLowerCase().trim();
            const fromLang = COMMON_PHRASES[fromCode];
            if (fromLang && fromLang[toCode] && fromLang[toCode][normalized]) {
                return fromLang[toCode][normalized];
            }
            return null;
        }

        /** CACHING & TRANSLATION **/
        function checkCache(text, toCode) {
             const h = JSON.parse(localStorage.getItem('gtr_history') || '[]');
             // Find exact match for text and target language
             const found = h.find(i => i.original.toLowerCase() === text.toLowerCase() && i.langCode === toCode);
             return found ? found.target : null;
        }

        async function translate(text, from, to) {
            // 1. Check Pre-Saved Phrases First (Zero API Cost)
            const preSaved = checkPreSaved(text, from.code, to.code);
            if(preSaved) {
                console.log("âœ… Pre-saved phrase! 0 tokens used.");
                saveHistory(text, preSaved, to.code);
                return preSaved;
            }

            // 2. Check Cache (Zero Token Cost)
            const cached = checkCache(text, to.code);
            if(cached) {
                console.log("âœ… Cache hit! 0 tokens used.");
                saveHistory(text, cached, to.code); // Bump to top of history
                return cached;
            }

            // 3. STRICT API Call - Output ONLY translation, no alternatives
            const prompt = `Translate this ${from.name} text to ${to.name}. Output ONLY the direct translation with no explanations, alternatives, notes, formatting, or extra text. Just the translated sentence:

${text}`;
            
            const result = await callGemini(prompt);
            
            // Clean up any markdown, asterisks, or formatting - take only first line
            const cleaned = result
                .replace(/\*\*/g, '')
                .replace(/\*/g, '')
                .replace(/\(/g, '')
                .replace(/\)/g, '')
                .trim()
                .split('\n')[0]
                .split('(')[0]
                .split('Alternatively')[0]
                .trim();
            
            saveHistory(text, cleaned, to.code);
            return cleaned;
        }

        /** TOOLS LOGIC **/
        let currentTool = null;

        // Optimized Tool Prompts for Token Efficiency
        const toolsConfig = {
            'phrasebook': { 
                title: 'Phrasebook', 
                hasInput: false,
                render: () => {
                   // Get pre-saved phrases for current language pair
                   const fromLang = COMMON_PHRASES[state.source.code];
                   let phrases = [];
                   
                   if (fromLang && fromLang[state.target.code]) {
                       phrases = Object.keys(fromLang[state.target.code]).map(k => 
                           k.charAt(0).toUpperCase() + k.slice(1)
                       );
                   } else {
                       // Default fallback phrases
                       phrases = ["Hello", "Thank you", "Goodbye", "Where is the bathroom?", "How much is this?", "Help me", "Water please", "Good morning", "Good night", "Yes", "No", "Please", "Sorry"];
                   }
                   
                   return `<div class="grid grid-cols-1 gap-2">${phrases.map(p => `<button onclick="translatePhrase('${p}')" class="text-left p-3 bg-slate-50 rounded-lg border hover:bg-slate-100 flex justify-between"><span>${p}</span> <i class="fas fa-chevron-right text-xs text-slate-400"></i></button>`).join('')}</div>`;
                }
            },
            'dictionary': { title: 'AI Dictionary', prompt: (t) => `Define simply in one short sentence: "${t}"` },
            'grammar': { title: 'Grammar Fixer', prompt: (t) => `Fix grammar and spelling. Output only the corrected text with no explanations: "${t}"` },
            'summarize': { title: 'Summarizer', prompt: (t) => `Summarize in 3 short bullets: "${t}"` },
            'tone': { title: 'Formalizer', prompt: (t) => `Make this formal and professional. Output only the rewritten text: "${t}"` },
            'quiz': {
                title: 'Quiz Mode',
                hasInput: false,
                render: () => {
                    const h = JSON.parse(localStorage.getItem('gtr_history') || '[]');
                    if(h.length < 3) return `<p class="text-center text-slate-500">Translate a few things first to unlock the quiz!</p>`;
                    const q = h[Math.floor(Math.random() * h.length)];
                    return `
                        <div class="text-center p-4">
                            <p class="text-sm text-slate-500 mb-2">What does this mean?</p>
                            <p class="text-xl font-bold mb-6">"${q.target}"</p>
                            <button onclick="this.nextElementSibling.classList.remove('hidden'); this.classList.add('hidden')" class="bg-indigo-600 text-white px-6 py-2 rounded-full">Reveal Answer</button>
                            <div class="hidden mt-4 animate-fade-in">
                                <p class="text-lg font-bold text-green-600">${q.original}</p>
                                <button onclick="launchTool('quiz')" class="mt-4 text-indigo-600 text-sm font-bold">Next Question</button>
                            </div>
                        </div>
                    `;
                }
            },
            'flashcards': {
                title: 'Flashcards',
                hasInput: false,
                render: () => {
                    const h = JSON.parse(localStorage.getItem('gtr_history') || '[]');
                    if(h.length === 0) return `<p class="text-center text-slate-500">No history found. Start translating!</p>`;
                    return `
                        <div class="space-y-2 max-h-60 overflow-y-auto">
                            ${h.slice(0, 20).map(i => `<div class="p-3 bg-yellow-50 border border-yellow-100 rounded-lg flex justify-between items-center"><div><div class="font-bold text-slate-800">${i.target}</div><div class="text-xs text-slate-500">${i.original}</div></div><button onclick="speak('${i.target.replace(/'/g, "\\'")}', '${i.langCode}')"><i class="fas fa-volume-up text-slate-400"></i></button></div>`).join('')}
                        </div>
                    `;
                }
            }
        };

        function launchTool(toolId) {
            currentTool = toolId;
            const config = toolsConfig[toolId];
            if(!config) return;

            const modal = document.getElementById('toolModal');
            const title = document.getElementById('toolTitle');
            const input = document.getElementById('toolInput');
            const result = document.getElementById('toolResult');
            const btn = document.getElementById('toolActionBtn');
            const content = document.getElementById('toolContent');

            title.textContent = config.title;
            result.classList.add('hidden');
            result.textContent = '';
            
            // Reset Layout
            input.classList.remove('hidden');
            btn.classList.remove('hidden');
            
            // Custom Render tools (No input needed)
            if(config.hasInput === false) {
                input.classList.add('hidden');
                btn.classList.add('hidden');
                result.classList.remove('hidden');
                result.innerHTML = config.render();
                result.classList.replace('bg-indigo-50', 'bg-white'); // Reset bg
            } else {
                result.classList.replace('bg-white', 'bg-indigo-50');
                input.value = '';
                btn.onclick = async () => {
                    if(!input.value.trim()) return;
                    btn.textContent = 'Processing...';
                    btn.disabled = true;
                    const res = await callGemini(config.prompt(input.value));
                    result.classList.remove('hidden');
                    result.textContent = res;
                    btn.textContent = 'Run';
                    btn.disabled = false;
                };
            }
            
            modal.classList.remove('hidden');
        }

        async function translatePhrase(phrase) {
            closeModal('toolModal');
            switchTab('voice');
            // Simulate voice input flow
            addChatBubble(phrase, 'user');
            const trans = await translate(phrase, state.source, state.target);
            addChatBubble(trans, 'ai');
            speak(trans, state.target.code);
        }

        function downloadData() {
            const data = localStorage.getItem('gtr_history') || '[]';
            const blob = new Blob([data], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'gemini-translator-history.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function toggleLargeText() {
            document.body.classList.toggle('large-text');
        }

        function toggleContrast() {
            document.body.classList.toggle('high-contrast');
        }

        /** VOICE & UI LOGIC **/
        function setupMicEvents() {
            // Main Mic
            const mainMic = document.getElementById('mainMicBtn');
            mainMic.onclick = () => toggleMic(state.source.code);

            // Split View Mics
            document.getElementById('convSourceMic').onclick = () => toggleMic(state.source.code, 'conv');
            document.getElementById('convTargetMic').onclick = () => toggleMic(state.target.code, 'conv');

            // Transcribe
            document.getElementById('transcribeBtn').onclick = toggleTranscribe;

            // Recognition Results
            recognition.onstart = () => {
                state.isListening = true;
                updateMicVisuals(true);
            };
            
            recognition.onend = () => {
                state.isListening = false;
                updateMicVisuals(false);
            };

            recognition.onresult = async (event) => {
                const text = event.results[0][0].transcript;
                
                if (state.activeTab === 'voice') {
                    addChatBubble(text, 'user');
                    const translation = await translate(text, state.source, state.target);
                    addChatBubble(translation, 'ai');
                    speak(translation, state.target.code);
                } else if (state.activeTab === 'conversation') {
                    // Detect which side initiated
                    const isSource = recognition.lang === state.source.code;
                    const elId = isSource ? 'convSourceText' : 'convTargetText';
                    const targetId = isSource ? 'convTargetText' : 'convSourceText';
                document.getElementById(elId).textContent = text;
                
                const from = isSource ? state.source : state.target;
                const to = isSource ? state.target : state.source;
                
                const trans = await translate(text, from, to);
                document.getElementById(targetId).textContent = trans;
                speak(trans, to.code);
            }
        };

        transcribeRecognition.onresult = async (e) => {
            for (let i = e.resultIndex; i < e.results.length; ++i) {
                if (e.results[i].isFinal) {
                    const original = e.results[i][0].transcript;
                    const trans = await translate(original, state.source, state.target);
                    appendTranscript(original, trans);
                }
            }
        };
    }

    function toggleMic(lang, mode = 'voice') {
        if (state.isListening) {
            recognition.stop();
            return;
        }
        recognition.lang = lang;
        recognition.start();
    }

    function toggleTranscribe() {
        const btn = document.getElementById('transcribeBtn');
        if (state.isListening) {
            transcribeRecognition.stop();
            state.isListening = false;
            btn.innerHTML = '<i class="fas fa-play"></i> Start Listening';
            btn.classList.remove('bg-red-600');
            btn.classList.add('bg-slate-800');
        } else {
            transcribeRecognition.lang = state.source.code;
            transcribeRecognition.start();
            state.isListening = true;
            btn.innerHTML = '<i class="fas fa-stop"></i> Stop';
            btn.classList.remove('bg-slate-800');
            btn.classList.add('bg-red-600');
        }
    }

    function updateMicVisuals(active) {
        const ids = ['mainMicBtn', 'convSourceMic', 'convTargetMic'];
        ids.forEach(id => {
            const el = document.getElementById(id);
            if(active) el.classList.add('pulse-ring');
            else el.classList.remove('pulse-ring');
        });
        const status = document.getElementById('voiceStatus');
        status.textContent = active ? "Listening..." : "Ready";
        status.className = active ? "text-[10px] font-bold text-red-500 uppercase tracking-widest bg-red-50 px-3 py-1 rounded-full shadow-sm" : "text-[10px] font-bold text-slate-400 uppercase tracking-widest bg-white px-3 py-1 rounded-full shadow-sm border border-slate-100";
    }

    function addChatBubble(text, type) {
        const container = document.getElementById('voiceChatContainer');
        // Remove placeholder if exists
        if(container.querySelector('.fa-microphone-alt')) container.innerHTML = '';
        
        const div = document.createElement('div');
        div.className = `flex w-full ${type==='user'?'justify-end':'justify-start'} animate-fade-in`;
        
        const bubble = document.createElement('div');
        bubble.className = `max-w-[80%] p-3 rounded-2xl text-sm shadow-sm ${type==='user'?'bg-indigo-600 text-white rounded-tr-none':'bg-white border border-slate-100 text-slate-800 rounded-tl-none'}`;
        bubble.textContent = text;
        
        if(type === 'ai') {
            const actions = document.createElement('div');
            actions.className = "flex gap-3 mt-2 text-slate-400 text-xs";
            actions.innerHTML = `<button onclick="speak('${text.replace(/'/g, "\\'")}', '${state.target.code}')"><i class="fas fa-volume-up"></i></button> <button onclick="copyToClip('${text.replace(/'/g, "\\'")}')"><i class="fas fa-copy"></i></button>`;
            bubble.appendChild(actions);
        }

        div.appendChild(bubble);
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    function appendTranscript(orig, trans) {
        const c = document.getElementById('transcribeContainer');
        const div = document.createElement('div');
        div.className = "p-3 bg-slate-800 rounded-lg animate-fade-in";
        div.innerHTML = `
            <div class="text-xs text-slate-500 mb-1">${orig}</div>
            <div class="text-indigo-300 font-medium">${trans}</div>
        `;
        c.appendChild(div);
        c.scrollTop = c.scrollHeight;
    }

    function speak(text, lang) {
        if(!synth) return;
        synth.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = lang;
        u.rate = 0.9;
        synth.speak(u);
    }

    function copyToClip(text) {
        navigator.clipboard.writeText(text).then(() => {
            // Successfully copied
        }).catch(err => {
            console.error('Copy failed:', err);
        });
    }

    /** NAVIGATION & STATE MANAGEMENT **/
    function switchTab(tabId) {
        state.activeTab = tabId;
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById(`view-${tabId}`).classList.add('active');
        
        // Update Nav Icons
        document.querySelectorAll('.nav-btn').forEach(btn => {
           btn.classList.remove('text-indigo-600');
           btn.classList.add('text-slate-400');
        });
        // Find button by onclick attr roughly
        const activeBtn = document.querySelector(`button[onclick="switchTab('${tabId}')"]`);
        if(activeBtn) {
            activeBtn.classList.remove('text-slate-400');
            activeBtn.classList.add('text-indigo-600');
        }

        // Stop mics on switch
        if(recognition) recognition.stop();
        if(transcribeRecognition) transcribeRecognition.stop();
    }

    function toggleInstall() {
        if(state.installPrompt) {
            state.installPrompt.prompt();
            state.installPrompt.userChoice.then((choice) => {
                if (choice.outcome === 'accepted') {
                    document.getElementById('installBtn').classList.add('hidden');
                }
                state.installPrompt = null;
            });
        } else {
            // Fallback for logic check
            alert("Installation not available directly. Please use your browser menu to 'Add to Home Screen'.");
        }
    }

    /** LANGUAGE MODAL **/
    function openLangModal(side) {
        state.selectingFor = side;
        document.getElementById('langModal').classList.remove('hidden');
        document.getElementById('langSearch').value = '';
        document.getElementById('langSearch').focus();
        renderLangList();
    }

    function closeModal(id) {
        document.getElementById(id).classList.add('hidden');
    }

    function renderLangList(filter = '') {
        const list = document.getElementById('langList');
        list.innerHTML = '';
        LANGUAGES.filter(l => l.name.toLowerCase().includes(filter.toLowerCase())).forEach(lang => {
            const btn = document.createElement('button');
            btn.className = "w-full text-left p-3 hover:bg-slate-50 rounded-lg flex items-center gap-3 border-b border-slate-50";
            btn.innerHTML = `<span class="text-xl">${lang.flag}</span> <span class="text-sm font-medium text-slate-700">${lang.name}</span>`;
            btn.onclick = () => selectLang(lang);
            list.appendChild(btn);
        });
    }

    function selectLang(lang) {
        if(state.selectingFor === 'source') state.source = lang;
        else state.target = lang;
        updateLangUI();
        closeModal('langModal');
    }

    document.getElementById('langSearch').addEventListener('input', (e) => renderLangList(e.target.value));

    document.getElementById('swapBtn').onclick = () => {
        const temp = state.source;
        state.source = state.target;
        state.target = temp;
        updateLangUI();
        
        // Animation
        const i = document.querySelector('#swapBtn i');
        i.style.transform = 'rotate(180deg)';
        setTimeout(() => i.style.transform = 'rotate(0deg)', 300);
    };

    function updateLangUI() {
        document.querySelector('.text-source').textContent = state.source.name;
        document.querySelector('.flag-source').textContent = state.source.flag;
        document.querySelector('.text-target').textContent = state.target.name;
        document.querySelector('.flag-target').textContent = state.target.flag;
    }

    /** HISTORY **/
    function saveHistory(original, target, langCode) {
        const h = JSON.parse(localStorage.getItem('gtr_history') || '[]');
        // Remove existing duplicate if any to bump to top
        const existingIdx = h.findIndex(i => i.original.toLowerCase() === original.toLowerCase() && i.langCode === langCode);
        if(existingIdx > -1) h.splice(existingIdx, 1);
        
        h.unshift({ original, target, langCode, date: Date.now() });
        localStorage.setItem('gtr_history', JSON.stringify(h.slice(0, 100)));
    }

    window.onload = init;
</script>
</body>
</html>

