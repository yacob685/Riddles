<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Race Master Pro: Tuner Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; user-select: none; -webkit-user-select: none; }
        
        /* LAYERS */
        #game-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #garage-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; background: radial-gradient(circle at center, #1a1a2e 0%, #000000 100%); pointer-events: none; opacity: 0; transition: opacity 0.5s; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        
        .pointer-events-auto { pointer-events: auto; }
        .hidden-panel { display: none !important; }
        .visible-panel { display: flex !important; }
        
        /* UI COMPONENTS */
        .glass-panel {
            background: rgba(15, 15, 20, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0,0,0,0.6);
        }
        
        .btn-action {
            background: linear-gradient(135deg, #ff0055, #cc0000);
            box-shadow: 0 4px 15px rgba(255, 0, 85, 0.4);
            color: white;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
            border: none;
        }
        .btn-action:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 0, 85, 0.6); }
        .btn-action:active { transform: translateY(0); }
        .btn-action:disabled { background: #333; color: #666; box-shadow: none; cursor: not-allowed; }

        .btn-secondary {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            transition: all 0.2s;
        }
        .btn-secondary:hover { background: rgba(255,255,255,0.1); }

        .menu-card {
            transition: transform 0.2s, border-color 0.2s;
        }
        .menu-card:hover {
            transform: scale(1.02);
            border-color: rgba(255,255,255,0.4);
        }

        /* Garage Stats Bars */
        .stat-bar-bg { width: 100%; height: 8px; background: #222; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .stat-bar-fill { height: 100%; background: linear-gradient(90deg, #00d2ff, #3a7bd5); transition: width 0.5s ease-out; }

        /* Animations */
        @keyframes pulse-border { 0% { border-color: rgba(255,0,85,0.5); } 50% { border-color: rgba(255,0,85,1); } 100% { border-color: rgba(255,0,85,0.5); } }
        .border-pulse { animation: pulse-border 2s infinite; }
        
        .currency-display { font-family: 'Courier New', monospace; color: #ffd700; text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
    </style>
</head>
<body>

    <!-- 3D Containers -->
    <div id="game-layer"></div>
    <div id="garage-layer"><canvas id="garage-canvas"></canvas></div>

    <!-- UI Layer -->
    <div id="ui-layer" class="flex flex-col justify-center items-center font-sans">
        
        <!-- TOP BAR (Global) -->
        <div id="top-bar" class="absolute top-0 left-0 w-full p-4 flex justify-between items-start z-50 pointer-events-none hidden">
            <div class="glass-panel px-4 py-2 rounded-full flex items-center gap-3 pointer-events-auto">
                <span class="text-xs text-gray-400 font-bold">DRIVER</span>
                <span id="top-bar-name" class="text-white font-bold">Guest</span>
            </div>
            <div class="glass-panel px-4 py-2 rounded-full flex items-center gap-2 pointer-events-auto">
                <span class="text-yellow-400 text-xl">‚ö°</span>
                <span id="top-bar-cash" class="currency-display text-xl font-bold">0</span>
            </div>
        </div>

        <!-- 1. AUTH / LOADING -->
        <div id="loading-panel" class="absolute inset-0 bg-black flex flex-col items-center justify-center pointer-events-auto z-50">
            <h1 class="text-6xl font-black text-white italic tracking-tighter transform -skew-x-12 mb-2">RACE<span class="text-red-600">MASTER</span></h1>
            <h2 class="text-xl text-gray-500 font-light tracking-widest uppercase mb-8">Tuner Edition</h2>
            <div class="w-16 h-16 border-4 border-red-600 border-t-transparent rounded-full animate-spin"></div>
            <p id="loading-text" class="text-gray-500 mt-4 text-sm animate-pulse">Initializing Engine...</p>
        </div>

        <!-- 2. MAIN MENU (UPDATED) -->
        <div id="menu-panel" class="hidden-panel absolute inset-0 flex flex-col items-center justify-center pointer-events-auto bg-black/40 backdrop-blur-sm z-40">
            <div class="w-full max-w-5xl px-6">
                <div class="text-center mb-10">
                    <h1 class="text-6xl font-black text-white italic tracking-tighter transform -skew-x-6 drop-shadow-2xl">SELECT <span class="text-transparent bg-clip-text bg-gradient-to-r from-red-500 to-orange-500">MODE</span></h1>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    
                    <!-- Tab 1: Solo -->
                    <button id="btn-mode-solo" class="menu-card group relative h-80 glass-panel rounded-2xl p-6 text-left border border-gray-700 hover:border-blue-500 flex flex-col justify-between overflow-hidden">
                        <div class="absolute inset-0 bg-blue-900/20 group-hover:bg-blue-900/40 transition-colors z-0"></div>
                        <div class="relative z-10">
                            <span class="text-5xl mb-4 block">üèéÔ∏è</span>
                            <h2 class="text-3xl font-black text-white italic">SOLO<br>RACE</h2>
                            <p class="text-gray-400 text-sm mt-2">Versus 4 Bots. 100 Levels.</p>
                            <div class="mt-4 inline-block bg-black/50 px-3 py-1 rounded text-xs border border-blue-500/30 text-blue-300">
                                Current Level: <span id="menu-level-display" class="font-bold text-white">1</span>
                            </div>
                        </div>
                        <div class="relative z-10 mt-auto">
                            <span class="text-blue-400 font-bold tracking-widest text-xs uppercase group-hover:underline">Instant Start &rarr;</span>
                        </div>
                    </button>

                    <!-- Tab 2: Multiplayer -->
                    <button id="btn-mode-multi" class="menu-card group relative h-80 glass-panel rounded-2xl p-6 text-left border border-gray-700 hover:border-red-500 flex flex-col justify-between overflow-hidden">
                        <div class="absolute inset-0 bg-red-900/20 group-hover:bg-red-900/40 transition-colors z-0"></div>
                        <div class="relative z-10">
                            <span class="text-5xl mb-4 block">üåê</span>
                            <h2 class="text-3xl font-black text-white italic">ONLINE<br>PVP</h2>
                            <p class="text-gray-400 text-sm mt-2">Race against real players in real-time lobbies.</p>
                        </div>
                        <div class="relative z-10 mt-auto">
                            <span class="text-red-400 font-bold tracking-widest text-xs uppercase group-hover:underline">Enter Lobby &rarr;</span>
                        </div>
                    </button>

                    <!-- Tab 3: Garage -->
                    <button id="btn-mode-garage" class="menu-card group relative h-80 glass-panel rounded-2xl p-6 text-left border border-gray-700 hover:border-yellow-500 flex flex-col justify-between overflow-hidden">
                        <div class="absolute inset-0 bg-yellow-900/20 group-hover:bg-yellow-900/40 transition-colors z-0"></div>
                        <div class="relative z-10">
                            <span class="text-5xl mb-4 block">üîß</span>
                            <h2 class="text-3xl font-black text-white italic">MY<br>GARAGE</h2>
                            <p class="text-gray-400 text-sm mt-2">Upgrade stats and customize your ride.</p>
                        </div>
                        <div class="relative z-10 mt-auto">
                            <span class="text-yellow-400 font-bold tracking-widest text-xs uppercase group-hover:underline">Tune Up &rarr;</span>
                        </div>
                    </button>

                </div>
            </div>
        </div>

        <!-- 3. GARAGE -->
        <div id="garage-panel" class="hidden-panel absolute inset-0 flex flex-col justify-between p-6 pointer-events-none z-40">
            <!-- Left: Stats -->
            <div class="glass-panel p-6 rounded-xl w-full max-w-xs pointer-events-auto self-start mt-16 transform -skew-x-2">
                <h3 class="text-xl font-black text-white italic mb-4 border-b border-gray-700 pb-2">PERFORMANCE</h3>
                
                <div class="space-y-4">
                    <!-- Speed -->
                    <div>
                        <div class="flex justify-between text-xs font-bold text-gray-400 uppercase mb-1">
                            <span>Top Speed</span>
                            <span class="text-white" id="stat-val-speed">100</span>
                        </div>
                        <div class="stat-bar-bg"><div id="bar-speed" class="stat-bar-fill" style="width: 20%"></div></div>
                        <button id="btn-upg-speed" class="mt-2 w-full py-2 bg-gray-800 hover:bg-gray-700 border border-gray-600 text-white text-xs font-bold rounded flex justify-between px-3">
                            <span>UPGRADE</span>
                            <span class="text-yellow-400">$<span id="cost-speed">500</span></span>
                        </button>
                    </div>

                    <!-- Accel -->
                    <div>
                        <div class="flex justify-between text-xs font-bold text-gray-400 uppercase mb-1">
                            <span>Acceleration</span>
                            <span class="text-white" id="stat-val-accel">100</span>
                        </div>
                        <div class="stat-bar-bg"><div id="bar-accel" class="stat-bar-fill" style="width: 20%"></div></div>
                        <button id="btn-upg-accel" class="mt-2 w-full py-2 bg-gray-800 hover:bg-gray-700 border border-gray-600 text-white text-xs font-bold rounded flex justify-between px-3">
                            <span>UPGRADE</span>
                            <span class="text-yellow-400">$<span id="cost-accel">500</span></span>
                        </button>
                    </div>

                    <!-- Handling -->
                    <div>
                        <div class="flex justify-between text-xs font-bold text-gray-400 uppercase mb-1">
                            <span>Handling</span>
                            <span class="text-white" id="stat-val-hand">100</span>
                        </div>
                        <div class="stat-bar-bg"><div id="bar-hand" class="stat-bar-fill" style="width: 20%"></div></div>
                        <button id="btn-upg-hand" class="mt-2 w-full py-2 bg-gray-800 hover:bg-gray-700 border border-gray-600 text-white text-xs font-bold rounded flex justify-between px-3">
                            <span>UPGRADE</span>
                            <span class="text-yellow-400">$<span id="cost-hand">500</span></span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Bottom: Paint & Back -->
            <div class="flex justify-between items-end w-full pointer-events-auto">
                <div class="glass-panel p-4 rounded-xl flex gap-2">
                    <button class="w-10 h-10 rounded-full border-2 border-white/20 hover:scale-110 transition-transform bg-red-600" onclick="setCarColor('#ff0000')"></button>
                    <button class="w-10 h-10 rounded-full border-2 border-white/20 hover:scale-110 transition-transform bg-blue-600" onclick="setCarColor('#0066ff')"></button>
                    <button class="w-10 h-10 rounded-full border-2 border-white/20 hover:scale-110 transition-transform bg-green-500" onclick="setCarColor('#00ff44')"></button>
                    <button class="w-10 h-10 rounded-full border-2 border-white/20 hover:scale-110 transition-transform bg-yellow-400" onclick="setCarColor('#ffcc00')"></button>
                    <button class="w-10 h-10 rounded-full border-2 border-white/20 hover:scale-110 transition-transform bg-purple-600" onclick="setCarColor('#9900ff')"></button>
                    <button class="w-10 h-10 rounded-full border-2 border-white/20 hover:scale-110 transition-transform bg-white" onclick="setCarColor('#ffffff')"></button>
                    <button class="w-10 h-10 rounded-full border-2 border-white/20 hover:scale-110 transition-transform bg-gray-900" onclick="setCarColor('#111111')"></button>
                </div>

                <button id="btn-exit-garage" class="btn-secondary px-8 py-3 rounded-xl font-bold uppercase tracking-wider">
                    Save & Back
                </button>
            </div>
        </div>

        <!-- 4. LOBBY -->
        <div id="lobby-panel" class="hidden-panel absolute inset-0 flex items-center justify-center bg-black/80 backdrop-blur pointer-events-auto z-40">
            <div class="glass-panel p-8 rounded-2xl w-full max-w-md text-center border border-gray-700">
                <h2 class="text-3xl font-black text-white italic mb-6">MULTIPLAYER LOBBY</h2>
                
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <button id="tab-create" class="p-4 rounded-xl bg-gray-800 border-2 border-red-600 text-white">Create Room</button>
                    <button id="tab-join" class="p-4 rounded-xl bg-gray-900 border border-gray-700 text-gray-400">Join Room</button>
                </div>

                <!-- Create Mode -->
                <div id="view-create" class="space-y-4">
                    <p class="text-gray-400 text-sm">Host a private race for your friends.</p>
                    <button id="btn-create-room" class="btn-action w-full py-3 rounded-xl">Generate Room Code</button>
                </div>

                <!-- Join Mode -->
                <div id="view-join" class="hidden space-y-4">
                    <input type="text" id="input-room-code" class="w-full bg-black border border-gray-600 rounded-lg p-3 text-center text-xl font-mono text-white uppercase placeholder-gray-600 focus:border-red-500 outline-none" placeholder="CODE" maxlength="4">
                    <button id="btn-join-room" class="btn-action w-full py-3 rounded-xl">Enter Room</button>
                </div>

                <button id="btn-lobby-back" class="mt-6 text-gray-500 text-sm hover:text-white underline">Back to Menu</button>
            </div>
        </div>

        <!-- 5. WAITING ROOM -->
        <div id="waiting-panel" class="hidden-panel absolute inset-0 flex items-center justify-center bg-black/90 pointer-events-auto z-40">
            <div class="glass-panel p-8 rounded-2xl w-full max-w-lg text-center">
                <div class="text-xs text-gray-400 font-bold uppercase mb-1">Room Code</div>
                <div id="display-room-code" class="text-6xl font-mono font-bold text-white mb-8 tracking-wider select-all cursor-pointer">????</div>
                
                <div class="text-left mb-8">
                    <h4 class="text-xs font-bold text-gray-500 uppercase mb-3">Racers</h4>
                    <div id="player-list" class="space-y-2">
                        <!-- Player items injected here -->
                    </div>
                </div>

                <div id="host-controls" class="hidden">
                    <button id="btn-start-race" class="btn-action w-full py-4 rounded-xl text-lg animate-pulse">START ENGINE</button>
                </div>
                <div id="guest-controls">
                    <p class="text-yellow-500 font-mono text-sm">WAITING FOR HOST...</p>
                </div>
            </div>
        </div>

        <!-- HUD -->
        <div id="hud-panel" class="hidden-panel w-full h-full relative pointer-events-none z-30">
            <!-- Speedometer -->
            <div class="absolute bottom-6 right-6 glass-panel rounded-full w-32 h-32 flex flex-col items-center justify-center border-4 border-gray-800">
                <span id="hud-speed" class="text-4xl font-black text-white italic">0</span>
                <span class="text-xs text-gray-400 font-bold">KM/H</span>
            </div>
            
            <!-- Boost Button/Meter -->
            <div class="absolute bottom-6 right-44 pointer-events-auto">
                <button id="btn-boost" class="glass-panel rounded-xl px-6 py-4 w-48 hover:bg-white/10 active:scale-95 transition-all group border-red-500/50">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs text-gray-400 font-bold uppercase group-hover:text-white">NITRO</span>
                        <!-- New Status Logic: Will be populated by JS -->
                        <span id="boost-status" class="text-xs font-bold text-yellow-500">CHECKING</span>
                    </div>
                    <div class="w-full h-4 bg-gray-800 rounded-full overflow-hidden border border-gray-700 relative">
                         <!-- Visual bar just for effect -->
                        <div id="boost-bar" class="h-full bg-gradient-to-r from-red-500 to-yellow-500 w-full animate-pulse"></div>
                    </div>
                    <div class="text-center mt-2 text-[10px] text-gray-500 font-mono uppercase">SPACE to ACTIVATE</div>
                </button>
            </div>

            <!-- Pos -->
            <div class="absolute top-20 left-4 glass-panel px-4 py-2 rounded-lg">
                <span class="text-gray-400 text-xs font-bold block">POS</span>
                <span id="hud-pos" class="text-2xl font-black text-white">1/5</span>
            </div>

            <!-- Level (Solo Only) -->
            <div id="hud-level-display" class="absolute top-20 right-4 glass-panel px-4 py-2 rounded-lg text-right hidden">
                <span class="text-gray-400 text-xs font-bold block">LEVEL</span>
                <span id="current-level-hud" class="text-2xl font-black text-blue-400">1</span>
            </div>
            
            <!-- Controls Hint -->
            <div class="absolute bottom-10 left-0 w-full text-center opacity-40">
                <p class="text-white text-sm font-bold shadow-black drop-shadow-md">HOLD TO GAS ‚Ä¢ SLIDE TO STEER</p>
            </div>

            <!-- Countdown -->
            <div id="countdown-overlay" class="absolute inset-0 flex items-center justify-center hidden">
                <span id="countdown-text" class="text-9xl font-black text-white italic drop-shadow-[0_10px_10px_rgba(0,0,0,0.8)]">3</span>
            </div>
        </div>

        <!-- AD / MONEY OVERLAY -->
        <div id="ad-overlay" class="hidden-panel absolute inset-0 bg-black/80 flex items-center justify-center z-[100] pointer-events-auto">
            <div class="glass-panel p-8 rounded-2xl max-w-sm text-center border-2 border-yellow-500">
                <h3 class="text-3xl font-black text-white italic mb-2">OUT OF CASH!</h3>
                <p class="text-gray-300 mb-6">You need <span class="text-yellow-400 font-bold">$500</span> for Nitro.</p>
                
                <div id="ad-content">
                    <button id="btn-watch-ad" class="w-full py-4 bg-yellow-600 hover:bg-yellow-500 text-white font-bold rounded-xl shadow-lg shadow-yellow-500/20 mb-3 flex items-center justify-center gap-2">
                        <span>üì∫ WATCH AD</span>
                        <span class="bg-black/20 px-2 rounded text-sm">+$600</span>
                    </button>
                    <button id="btn-close-ad" class="text-gray-500 text-xs underline hover:text-white">No Thanks (Continue Slow)</button>
                </div>
                
                <div id="ad-loading" class="hidden flex-col items-center">
                    <div class="w-10 h-10 border-4 border-yellow-500 border-t-transparent rounded-full animate-spin mb-2"></div>
                    <span class="text-yellow-500 text-sm font-bold animate-pulse">PLAYING AD...</span>
                </div>
            </div>
        </div>

        <!-- RESULTS -->
        <div id="result-panel" class="hidden-panel absolute inset-0 flex items-center justify-center bg-black/80 z-50 pointer-events-auto">
            <div class="glass-panel p-10 rounded-2xl text-center transform scale-110 border-t-4 border-yellow-500">
                <div id="result-title" class="text-5xl font-black text-white italic mb-2">FINISH!</div>
                <div class="text-2xl text-gray-300 mb-4">Position: <span id="result-pos" class="text-white font-bold">#1</span></div>
                <div class="bg-yellow-500/20 text-yellow-400 p-4 rounded-lg mb-6 border border-yellow-500/50">
                    <div class="text-xs font-bold uppercase">Prize Money</div>
                    <div class="text-3xl font-bold font-mono">+$<span id="result-money">0</span></div>
                </div>
                <div id="level-up-msg" class="hidden text-blue-400 font-bold mb-4 text-xl animate-bounce">LEVEL COMPLETED!</div>
                <button onclick="location.reload()" class="btn-secondary px-8 py-3 rounded-full">Return to Garage</button>
            </div>
        </div>
    </div>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // ==========================================
        // 1. CONFIG & STATE
        // ==========================================
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'race-master-default';
        
        const firebaseConfig = {
            apiKey: "AIzaSyB-3kAk-lMT3jTny2YIs2R1_0mG-tJlmJI",
            authDomain: "puzzlesapp.firebaseapp.com",
            databaseURL: "https://puzzlesapp-default-rtdb.firebaseio.com",
            projectId: "puzzlesapp",
            storageBucket: "puzzlesapp.firebasestorage.app",
            messagingSenderId: "303461259730",
            appId: "1:303461259730:web:a1790a976b6d58d71dd00b",
            measurementId: "G-8YEJEBX0NE"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Player Profile State
        let userProfile = {
            uid: null,
            name: 'Racer' + Math.floor(Math.random() * 999),
            cash: 1000,
            color: '#ff0055',
            stats: {
                speed: 1, // Level 1-10
                accel: 1,
                handling: 1
            },
            currentLevel: 1, // Solo campaign level
            nitroStock: 0 // New persistent nitro stock
        };

        const UPGRADE_COST_BASE = 500;
        const MAX_LEVEL = 10;
        const BOOST_COST = 500;
        const AD_REWARD = 600;

        // Game State
        let currentRoomId = null;
        let isHost = false;
        let isSinglePlayer = false; 
        let roomUnsubscribe = null;
        let playersMap = {}; 
        let bots = []; // Local AI Bots
        let gameStatus = 'menu'; // menu, garage, waiting, racing, finished

        // 3D Globals
        let scene, camera, renderer; // Race Scene
        let garageScene, garageCamera, garageRenderer, garageCar; // Garage Scene
        let myCar;
        let opponentCars = {};
        let trackGroup, obstacles = [];
        let clock = new THREE.Clock();

        // Physics Constants (Calculated from Stats)
        let phys = {
            maxSpeed: 1.0,
            accel: 0.01,
            turnSpeed: 0.1
        };
        let currentSpeed = 0;
        let isRespawning = false; // New Respawn Flag
        let inputState = { holding: false, steer: 0 };
        
        // Boost System
        let boostActive = false;
        let boostCooldown = 0;
        const BOOST_DURATION = 120; // Frames (~2 seconds at 60fps)
        const BOOST_MULTIPLIER = 2.2; 

        // ==========================================
        // 2. AUTH & PROFILE MANAGER
        // ==========================================
        
        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                console.warn("Auth failed, falling back to anonymous:", e);
                await signInAnonymously(auth);
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userProfile.uid = user.uid;
                try {
                    await loadProfile();
                    updateUI();
                    initGarage3D();
                    document.getElementById('loading-panel').classList.add('hidden-panel');
                    document.getElementById('menu-panel').classList.remove('hidden-panel');
                    document.getElementById('top-bar').classList.remove('hidden');
                } catch (e) {
                    console.error("Profile load error:", e);
                    document.getElementById('loading-text').innerText = "Error loading profile...";
                }
            } else {
                console.warn("No authenticated user");
                document.getElementById('loading-text').innerText = "Authentication failed...";
            }
        });

        async function loadProfile() {
            const ref = doc(db, 'artifacts', appId, 'users', userProfile.uid);
            try {
                const snap = await getDoc(ref);
                if (snap.exists()) {
                    const data = snap.data();
                    userProfile.name = data.name || userProfile.name;
                    userProfile.cash = data.cash !== undefined ? data.cash : 1000;
                    userProfile.color = data.color || '#ff0055';
                    userProfile.currentLevel = data.currentLevel || 1;
                    userProfile.nitroStock = data.nitroStock !== undefined ? data.nitroStock : 0;
                    if (data.stats) userProfile.stats = data.stats;
                } else {
                    await saveProfile(); // Create initial
                }
            } catch (e) { console.error("Load Error", e); }
        }

        async function saveProfile() {
            const ref = doc(db, 'artifacts', appId, 'users', userProfile.uid);
            await setDoc(ref, {
                name: userProfile.name,
                cash: userProfile.cash,
                color: userProfile.color,
                stats: userProfile.stats,
                currentLevel: userProfile.currentLevel,
                nitroStock: userProfile.nitroStock
            });
            updateUI();
        }

        // ==========================================
        // 3. CAR GENERATOR
        // ==========================================
        
        function createDetailedCar(colorHex) {
            const carGroup = new THREE.Group();
            const mainColor = new THREE.Color(colorHex);
            const blackMat = new THREE.MeshStandardMaterial({ color: 0x111111, roughness: 0.5 });
            const bodyMat = new THREE.MeshStandardMaterial({ color: mainColor, metalness: 0.6, roughness: 0.2 });
            const glassMat = new THREE.MeshStandardMaterial({ color: 0x000000, metalness: 0.9, roughness: 0.1 });
            const lightMat = new THREE.MeshBasicMaterial({ color: 0xffffaa });
            const tailLightMat = new THREE.MeshBasicMaterial({ color: 0xff0000 });

            // 1. Chassis (Main Body)
            const chassisGeo = new THREE.BoxGeometry(2, 0.5, 4.2);
            const chassis = new THREE.Mesh(chassisGeo, bodyMat);
            chassis.position.y = 0.5;
            chassis.castShadow = true;
            carGroup.add(chassis);

            // 2. Cockpit/Roof
            const cockpitGeo = new THREE.BoxGeometry(1.6, 0.4, 2);
            const cockpit = new THREE.Mesh(cockpitGeo, glassMat);
            cockpit.position.set(0, 0.9, -0.2);
            carGroup.add(cockpit);

            // 3. Hood Scoop (Detail)
            const scoopGeo = new THREE.BoxGeometry(1, 0.1, 1);
            const scoop = new THREE.Mesh(scoopGeo, bodyMat);
            scoop.position.set(0, 0.76, 1.2);
            carGroup.add(scoop);

            // 4. Spoiler
            const spoilerWingGeo = new THREE.BoxGeometry(2.2, 0.1, 0.5);
            const spoilerWing = new THREE.Mesh(spoilerWingGeo, bodyMat);
            spoilerWing.position.set(0, 1.2, -1.9);
            carGroup.add(spoilerWing);

            const spoilerPostGeo = new THREE.BoxGeometry(0.1, 0.4, 0.1);
            const p1 = new THREE.Mesh(spoilerPostGeo, blackMat); p1.position.set(0.8, 0.9, -1.9);
            const p2 = new THREE.Mesh(spoilerPostGeo, blackMat); p2.position.set(-0.8, 0.9, -1.9);
            carGroup.add(p1); carGroup.add(p2);

            // 5. Wheels
            const wheelGeo = new THREE.CylinderGeometry(0.45, 0.45, 0.3, 24);
            const wheelMat = new THREE.MeshStandardMaterial({ color: 0x222222 });
            const rimGeo = new THREE.CylinderGeometry(0.3, 0.3, 0.31, 8);
            const rimMat = new THREE.MeshStandardMaterial({ color: 0x888888, metalness: 0.8 });

            const wheelPositions = [
                { x: 1.1, z: 1.3 }, { x: -1.1, z: 1.3 },
                { x: 1.1, z: -1.3 }, { x: -1.1, z: -1.3 }
            ];

            wheelPositions.forEach(pos => {
                const w = new THREE.Group();
                const tire = new THREE.Mesh(wheelGeo, wheelMat);
                const rim = new THREE.Mesh(rimGeo, rimMat);
                tire.rotation.z = Math.PI / 2;
                rim.rotation.z = Math.PI / 2;
                w.add(tire);
                w.add(rim);
                w.position.set(pos.x, 0.45, pos.z);
                carGroup.add(w);
            });

            // 6. Lights
            const headLightGeo = new THREE.PlaneGeometry(0.4, 0.2);
            const hl1 = new THREE.Mesh(headLightGeo, lightMat);
            hl1.position.set(0.6, 0.6, 2.11);
            hl1.rotation.y = 0; // Front facing
            carGroup.add(hl1);
            const hl2 = hl1.clone();
            hl2.position.set(-0.6, 0.6, 2.11);
            carGroup.add(hl2);

            const tailLightGeo = new THREE.PlaneGeometry(0.4, 0.15);
            const tl1 = new THREE.Mesh(tailLightGeo, tailLightMat);
            tl1.position.set(0.6, 0.6, -2.11);
            tl1.rotation.y = Math.PI; // Back facing
            carGroup.add(tl1);
            const tl2 = tl1.clone();
            tl2.position.set(-0.6, 0.6, -2.11);
            carGroup.add(tl2);

            return carGroup;
        }

        // ==========================================
        // 4. GARAGE SYSTEM
        // ==========================================

        function initGarage3D() {
            const canvas = document.getElementById('garage-canvas');
            garageScene = new THREE.Scene();
            
            garageCamera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
            garageCamera.position.set(5, 3, 5);
            garageCamera.lookAt(0, 0.5, 0);

            garageRenderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true, antialias: true });
            garageRenderer.setSize(window.innerWidth, window.innerHeight);
            garageRenderer.setPixelRatio(window.devicePixelRatio);
            garageRenderer.shadowMap.enabled = true;

            // Lights
            const ambient = new THREE.AmbientLight(0xffffff, 0.5);
            garageScene.add(ambient);
            const spot = new THREE.SpotLight(0xffffff, 2);
            spot.position.set(5, 10, 5);
            spot.castShadow = true;
            garageScene.add(spot);
            
            const rimLight = new THREE.PointLight(0x00d2ff, 1);
            rimLight.position.set(-5, 2, -5);
            garageScene.add(rimLight);

            // Floor
            const floorGeo = new THREE.CircleGeometry(4, 32);
            const floorMat = new THREE.MeshStandardMaterial({ color: 0x111111, metalness: 0.5, roughness: 0.1 });
            const floor = new THREE.Mesh(floorGeo, floorMat);
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            garageScene.add(floor);

            updateGarageCar();
            animateGarage();
        }

        function updateGarageCar() {
            if (garageCar) garageScene.remove(garageCar);
            garageCar = createDetailedCar(userProfile.color);
            garageCar.position.y = 0;
            garageScene.add(garageCar);
        }

        function animateGarage() {
            if (gameStatus === 'garage') {
                requestAnimationFrame(animateGarage);
                if (garageCar) garageCar.rotation.y += 0.005;
                garageRenderer.render(garageScene, garageCamera);
            }
        }

        window.setCarColor = (c) => {
            userProfile.color = c;
            updateGarageCar();
        };

        function buyUpgrade(type) {
            const level = userProfile.stats[type];
            if (level >= MAX_LEVEL) return;
            
            const cost = UPGRADE_COST_BASE * level;
            if (userProfile.cash >= cost) {
                userProfile.cash -= cost;
                userProfile.stats[type]++;
                updateUI();
                // Visual feedback
                const btn = document.getElementById(`btn-upg-${type}`);
                btn.classList.add('border-pulse');
                setTimeout(() => btn.classList.remove('border-pulse'), 500);
            } else {
                alert("Not enough cash!");
            }
        }

        // ==========================================
        // 5. UI CONTROLLER (UPDATED FOR 3 TABS)
        // ==========================================
        function updateUI() {
            // Top Bar
            document.getElementById('top-bar-name').innerText = userProfile.name;
            document.getElementById('top-bar-cash').innerText = userProfile.cash;

            // Menu Display
            document.getElementById('menu-level-display').innerText = userProfile.currentLevel;

            // Garage Stats
            const stats = ['speed', 'accel', 'hand']; 
            const map = { speed: 'speed', accel: 'accel', hand: 'handling' };
            
            stats.forEach(key => {
                const lvl = userProfile.stats[map[key]];
                const pct = (lvl / MAX_LEVEL) * 100;
                const cost = UPGRADE_COST_BASE * lvl;
                
                document.getElementById(`stat-val-${key}`).innerText = `LVL ${lvl}`;
                document.getElementById(`bar-${key}`).style.width = `${pct}%`;
                
                const btn = document.getElementById(`btn-upg-${key}`);
                const costSpan = document.getElementById(`cost-${key}`);
                
                if (lvl >= MAX_LEVEL) {
                    btn.disabled = true;
                    btn.innerHTML = `<span class="text-gray-500">MAXED</span>`;
                } else {
                    btn.disabled = userProfile.cash < cost;
                    costSpan.innerText = cost;
                }
            });

            // Update Boost Button Text
            const boostStatus = document.getElementById('boost-status');
            const boostBtn = document.getElementById('btn-boost');
            if (userProfile.nitroStock > 0) {
                boostStatus.innerText = `READY x${userProfile.nitroStock}`;
                boostStatus.className = "text-xs font-bold text-green-400";
                boostBtn.classList.remove("border-red-500/50");
                boostBtn.classList.add("border-green-500/50");
            } else {
                boostStatus.innerText = `BUY 3: -$500`;
                boostStatus.className = "text-xs font-bold text-yellow-500";
                boostBtn.classList.add("border-red-500/50");
                boostBtn.classList.remove("border-green-500/50");
            }
        }

        // Navigation Handlers

        // 1. GARAGE MODE
        document.getElementById('btn-mode-garage').onclick = () => {
            gameStatus = 'garage';
            switchPanel('garage-panel');
            document.getElementById('garage-layer').style.opacity = '1';
            document.getElementById('garage-layer').style.pointerEvents = 'auto';
            animateGarage();
        };

        // 2. MULTIPLAYER MODE
        document.getElementById('btn-mode-multi').onclick = () => {
            gameStatus = 'menu';
            isSinglePlayer = false;
            switchPanel('lobby-panel');
        };

        // 3. SOLO MODE (INSTANT START)
        document.getElementById('btn-mode-solo').onclick = () => {
            isSinglePlayer = true;
            gameStatus = 'racing';
            // Start immediate race with random seed
            startRace(Math.random());
        };

        // Back Buttons
        document.getElementById('btn-exit-garage').onclick = async () => {
            await saveProfile();
            gameStatus = 'menu';
            document.getElementById('garage-layer').style.opacity = '0';
            document.getElementById('garage-layer').style.pointerEvents = 'none';
            switchPanel('menu-panel');
        };

        document.getElementById('btn-lobby-back').onclick = () => {
            switchPanel('menu-panel');
        };

        function switchPanel(id) {
            ['menu-panel', 'garage-panel', 'lobby-panel', 'waiting-panel', 'hud-panel', 'result-panel'].forEach(pid => {
                const el = document.getElementById(pid);
                if (pid === id) el.classList.remove('hidden-panel');
                else el.classList.add('hidden-panel');
            });
        }

        // Upgrades Listeners
        document.getElementById('btn-upg-speed').onclick = () => buyUpgrade('speed');
        document.getElementById('btn-upg-accel').onclick = () => buyUpgrade('accel');
        document.getElementById('btn-upg-hand').onclick = () => buyUpgrade('handling');

        // Ad Logic Listeners
        document.getElementById('btn-boost').onclick = tryActivateBoost;
        
        document.getElementById('btn-watch-ad').onclick = async () => {
            document.getElementById('ad-content').classList.add('hidden');
            document.getElementById('ad-loading').classList.remove('hidden');
            document.getElementById('ad-loading').classList.add('flex');
            
            // Simulating Ad Watch
            setTimeout(async () => {
                userProfile.cash += AD_REWARD;
                await saveProfile();
                
                // Reset Ad Modal
                document.getElementById('ad-overlay').classList.add('hidden-panel');
                document.getElementById('ad-content').classList.remove('hidden');
                document.getElementById('ad-loading').classList.add('hidden');
                document.getElementById('ad-loading').classList.remove('flex');
                
                updateUI();
                alert(`Ad Complete! +$${AD_REWARD}`);
            }, 3000);
        };
        
        document.getElementById('btn-close-ad').onclick = () => {
            document.getElementById('ad-overlay').classList.add('hidden-panel');
        };

        // ==========================================
        // 6. MULTIPLAYER LOGIC
        // ==========================================

        document.getElementById('tab-create').onclick = () => {
            document.getElementById('view-create').classList.remove('hidden');
            document.getElementById('view-join').classList.add('hidden');
            document.getElementById('tab-create').classList.add('border-red-600', 'bg-gray-800');
            document.getElementById('tab-create').classList.remove('border-gray-700', 'bg-gray-900');
            document.getElementById('tab-join').classList.remove('border-red-600', 'bg-gray-800');
            document.getElementById('tab-join').classList.add('border-gray-700', 'bg-gray-900');
        };

        document.getElementById('tab-join').onclick = () => {
            document.getElementById('view-create').classList.add('hidden');
            document.getElementById('view-join').classList.remove('hidden');
            document.getElementById('tab-join').classList.add('border-red-600', 'bg-gray-800');
            document.getElementById('tab-join').classList.remove('border-gray-700', 'bg-gray-900');
            document.getElementById('tab-create').classList.remove('border-red-600', 'bg-gray-800');
            document.getElementById('tab-create').classList.add('border-gray-700', 'bg-gray-900');
        };

        document.getElementById('btn-create-room').onclick = async () => {
            const roomCode = Math.floor(1000 + Math.random() * 9000).toString();
            currentRoomId = roomCode;
            isHost = true;
            isSinglePlayer = false;
            
            const roomData = {
                host: userProfile.uid,
                status: 'waiting',
                created: serverTimestamp(),
                seed: Math.random(),
                players: {
                    [userProfile.uid]: {
                        name: userProfile.name,
                        color: userProfile.color,
                        stats: userProfile.stats,
                        x: 0, z: 0, speed: 0, finished: false
                    }
                }
            };

            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', roomCode), roomData);
            enterWaitingRoom();
        };

        document.getElementById('btn-join-room').onclick = async () => {
            const code = document.getElementById('input-room-code').value;
            if (code.length !== 4) return alert("Invalid Code");
            currentRoomId = code;
            isHost = false;
            isSinglePlayer = false;

            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', code);
            const snap = await getDoc(roomRef);
            if (!snap.exists()) return alert("Room not found");

            await updateDoc(roomRef, {
                [`players.${userProfile.uid}`]: {
                    name: userProfile.name,
                    color: userProfile.color,
                    stats: userProfile.stats,
                    x: 0, z: 0, speed: 0, finished: false
                }
            });
            enterWaitingRoom();
        };

        function enterWaitingRoom() {
            switchPanel('waiting-panel');
            document.getElementById('display-room-code').innerText = currentRoomId;
            document.getElementById('host-controls').style.display = isHost ? 'block' : 'none';
            document.getElementById('guest-controls').style.display = isHost ? 'none' : 'block';

            roomUnsubscribe = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId), (snap) => {
                if (!snap.exists()) {
                    alert("Room closed");
                    location.reload();
                    return;
                }
                const data = snap.data();
                playersMap = data.players || {};
                
                // Update List
                const list = document.getElementById('player-list');
                list.innerHTML = '';
                Object.values(playersMap).forEach(p => {
                    const div = document.createElement('div');
                    div.className = "flex items-center justify-between bg-gray-800 p-3 rounded border border-gray-700";
                    div.innerHTML = `<div class="flex items-center gap-3">
                        <div class="w-6 h-6 rounded shadow" style="background:${p.color}"></div>
                        <span class="text-white font-bold">${p.name}</span>
                    </div>`;
                    list.appendChild(div);
                });

                if ((gameStatus === 'menu' || gameStatus === 'garage') && data.status === 'racing') {
                    startRace(data.seed);
                }
            }, (err) => console.log(err));
        }

        document.getElementById('btn-start-race').onclick = async () => {
            if (!isHost) return;
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId), { status: 'racing' });
        };

        // ==========================================
        // 7. GAME ENGINE & NEW PHYSICS
        // ==========================================

        function startRace(seed) {
            gameStatus = 'racing';
            switchPanel('hud-panel');
            document.getElementById('waiting-panel').classList.add('hidden-panel');
            updateUI(); // Refresh HUD
            
            // Show level if singleplayer
            if (isSinglePlayer) {
                document.getElementById('hud-level-display').classList.remove('hidden');
                document.getElementById('current-level-hud').innerText = userProfile.currentLevel;
            } else {
                document.getElementById('hud-level-display').classList.add('hidden');
            }

            // RESET RACE STATE
            currentSpeed = 0;
            isRespawning = false;
            inputState = { holding: false, steer: 0 };
            clock = new THREE.Clock(); 
            opponentCars = {};
            bots = [];
            boostActive = false;
            boostCooldown = 0;
            
            // Calc Physics based on stats
            phys.maxSpeed = 1.8 + (userProfile.stats.speed * 0.15); 
            phys.accel = 0.04 + (userProfile.stats.accel * 0.005);
            phys.turnSpeed = 0.6 + (userProfile.stats.handling * 0.04);

            initRace3D(seed);
            
            if (isSinglePlayer) {
                // Initialize Bots - 4 Bots (Total 5 players)
                initBots(4); 
            }

            // Countdown
            const cd = document.getElementById('countdown-overlay');
            const txt = document.getElementById('countdown-text');
            cd.classList.remove('hidden');
            let count = 3;
            
            const intv = setInterval(() => {
                count--;
                if (count > 0) txt.innerText = count;
                else if (count === 0) txt.innerText = "GO!";
                else {
                    clearInterval(intv);
                    cd.classList.add('hidden');
                    startGameLoop();
                }
            }, 1000);
        }

        function initBots(count) {
            bots = [];
            const botColors = ['#ffaa00', '#00ffaa', '#aa00ff', '#ffffff', '#0099ff'];
            const levelMultiplier = 1 + (userProfile.currentLevel * 0.02); // Bots get faster each level
            
            for(let i=0; i<count; i++) {
                const speedVar = (Math.random() * 0.4) - 0.2; 
                bots.push({
                    id: `bot_${i}`,
                    name: `RacerBot ${i+1}`,
                    color: botColors[i % botColors.length],
                    x: (i+1) * 3 * (i%2===0?1:-1), // Stagger start pos
                    z: 0,
                    speed: 0,
                    maxSpeed: (phys.maxSpeed * levelMultiplier * 0.9) + speedVar, // Slight diff from player
                    accel: phys.accel * (0.9 + Math.random()*0.2) * levelMultiplier,
                    targetX: 0
                });
            }
            
            // Add bot cars to scene
            bots.forEach(bot => {
                const op = createDetailedCar(bot.color);
                op.position.set(bot.x, 0, 0);
                scene.add(op);
                opponentCars[bot.id] = op;
            });
            
            // Also need to set them in playersMap for HUD pos logic
            playersMap = {}; // clear multi map
            playersMap[userProfile.uid] = { z: 0 }; // Add self
            bots.forEach(b => {
                playersMap[b.id] = { z: 0 };
            });
        }

        let keydownHandler, keyupHandler, touchstartHandler, touchendHandler, touchmoveHandler;

        function removeInputListeners() {
            if (keydownHandler) window.removeEventListener('keydown', keydownHandler);
            if (keyupHandler) window.removeEventListener('keyup', keyupHandler);
            if (touchstartHandler) document.body.removeEventListener('touchstart', touchstartHandler);
            if (touchendHandler) document.body.removeEventListener('touchend', touchendHandler);
            if (touchmoveHandler) document.body.removeEventListener('touchmove', touchmoveHandler);
        }

       function initRace3D(seed) {
            const container = document.getElementById('game-layer');
            
            if (renderer) {
                renderer.dispose();
                renderer.forceContextLoss();
                renderer = null;
            }
            container.innerHTML = '';
            
            if (scene) {
                scene.traverse((obj) => {
                    if (obj.geometry) obj.geometry.dispose();
                    if (obj.material) {
                        if (Array.isArray(obj.material)) obj.material.forEach(m => m.dispose());
                        else obj.material.dispose();
                    }
                });
            }
            
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a2e);
            scene.fog = new THREE.FogExp2(0x1a1a2e, 0.002);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(0, 10, -15);
            camera.lookAt(0, 0, 10);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);

            // Lighting
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(50, 100, 50);
            dirLight.castShadow = true;
            dirLight.shadow.mapSize.width = 2048;
            dirLight.shadow.mapSize.height = 2048;
            dirLight.shadow.camera.near = 10;
            dirLight.shadow.camera.far = 500;
            dirLight.shadow.camera.left = -100;
            dirLight.shadow.camera.right = 100;
            dirLight.shadow.camera.top = 100;
            dirLight.shadow.camera.bottom = -100;
            scene.add(dirLight);
            scene.add(new THREE.AmbientLight(0xffffff, 0.4));

            generateTrack(seed);

            myCar = createDetailedCar(userProfile.color);
            scene.add(myCar);

            // Multiplayer Opponents (If not single player)
            if (!isSinglePlayer) {
                Object.entries(playersMap).forEach(([uid, p]) => {
                    if (uid !== userProfile.uid) {
                        const op = createDetailedCar(p.color);
                        scene.add(op);
                        opponentCars[uid] = op;
                    }
                });
            }

            // Input
            removeInputListeners();
            
            keydownHandler = (e) => {
                if(e.key==='w' || e.key==='ArrowUp') inputState.holding = true;
                if(e.key==='a' || e.key==='ArrowLeft') inputState.steer = 1;
                if(e.key==='d' || e.key==='ArrowRight') inputState.steer = -1;
                if(e.key===' ' || e.key==='Shift') tryActivateBoost();
            };
            keyupHandler = (e) => {
                if(e.key==='w' || e.key==='ArrowUp') inputState.holding = false;
                if(e.key==='a' || e.key==='ArrowLeft' || e.key==='d' || e.key==='ArrowRight') inputState.steer = 0;
            };
            
            window.addEventListener('keydown', keydownHandler);
            window.addEventListener('keyup', keyupHandler);

            // Touch
            touchstartHandler = (e) => { 
                inputState.holding = true;
                if (e.touches.length === 2) tryActivateBoost();
            };

            touchendHandler = (e) => { inputState.holding = false; };
            touchmoveHandler = (e) => {
                const x = e.touches[0].clientX;
                const mid = window.innerWidth / 2;
                inputState.steer = (mid - x) / (mid/2);
                if (inputState.steer > 1) inputState.steer = 1;
                if (inputState.steer < -1) inputState.steer = -1;
            };
            
            document.body.addEventListener('touchstart', touchstartHandler);
            document.body.addEventListener('touchend', touchendHandler);
            document.body.addEventListener('touchmove', touchmoveHandler);


            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth/window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        const TRACK_LEN = 5000;
        const TRACK_W = 40;

        function generateTrack(seed) {
            trackGroup = new THREE.Group();
            obstacles = [];
            
            // Road
            const roadGeo = new THREE.PlaneGeometry(TRACK_W, TRACK_LEN);
            const roadMat = new THREE.MeshPhongMaterial({ color: 0x333333 });
            const road = new THREE.Mesh(roadGeo, roadMat);
            road.rotation.x = -Math.PI/2;
            road.position.z = TRACK_LEN/2;
            road.receiveShadow = true;
            trackGroup.add(road);

            // Stripes
            const stripeGeo = new THREE.PlaneGeometry(1, TRACK_LEN);
            const stripeMat = new THREE.MeshBasicMaterial({ color: 0xffffff });
            const stripe = new THREE.Mesh(stripeGeo, stripeMat);
            stripe.rotation.x = -Math.PI/2;
            stripe.position.y = 0.05;
            stripe.position.z = TRACK_LEN/2;
            trackGroup.add(stripe);

            // Walls
            const wallGeo = new THREE.BoxGeometry(2, 3, TRACK_LEN);
            const wallMat = new THREE.MeshStandardMaterial({ color: 0xcc0000, metalness: 0.8 });
            const w1 = new THREE.Mesh(wallGeo, wallMat); w1.position.set(-TRACK_W/2 - 1, 1.5, TRACK_LEN/2);
            const w2 = new THREE.Mesh(wallGeo, wallMat); w2.position.set(TRACK_W/2 + 1, 1.5, TRACK_LEN/2);
            trackGroup.add(w1); trackGroup.add(w2);

            // Procedural Obstacles
            const rng = mulberry32(Math.floor(seed * 1000));
            const obsGeo = new THREE.BoxGeometry(6, 4, 6);
            const obsMat = new THREE.MeshStandardMaterial({ color: 0x4444ff, roughness: 0.2 });

            for(let z=200; z<TRACK_LEN-200; z+=100) {
                if (rng() > 0.4) {
                    const x = (rng() * (TRACK_W - 10)) - (TRACK_W/2) + 5;
                    const o = new THREE.Mesh(obsGeo, obsMat);
                    o.position.set(x, 2, z);
                    o.castShadow = true;
                    trackGroup.add(o);
                    obstacles.push(new THREE.Box3().setFromObject(o));
                }
            }

            // Finish Line
            const finGeo = new THREE.BoxGeometry(TRACK_W, 0.2, 5);
            const finMat = new THREE.MeshBasicMaterial({ color: 0xffffff });
            const fin = new THREE.Mesh(finGeo, finMat);
            fin.position.set(0, 0.1, TRACK_LEN);
            trackGroup.add(fin);

            scene.add(trackGroup);
        }

        async function tryActivateBoost() {
            if (boostActive || boostCooldown > 0 || isRespawning) return;

            // Logic: Pay 500 to buy 3 pack. Use 1.
            if (userProfile.nitroStock > 0) {
                // Have stock, use it
                userProfile.nitroStock--;
                await saveProfile();
                updateUI();
                activateBoostEffect();
            } else {
                // No stock, try buy pack
                if (userProfile.cash >= BOOST_COST) {
                    userProfile.cash -= BOOST_COST;
                    userProfile.nitroStock = 2; // Bought 3, using 1 now
                    await saveProfile();
                    updateUI();
                    activateBoostEffect();
                } else {
                    // Show Ad Overlay
                    document.getElementById('ad-overlay').classList.remove('hidden-panel');
                }
            }
        }

        function activateBoostEffect() {
            boostActive = true;
            boostCooldown = BOOST_DURATION;
            currentSpeed = Math.min(currentSpeed * 1.5, phys.maxSpeed * BOOST_MULTIPLIER);
            
            // Visual
            const bar = document.getElementById('boost-bar');
            bar.classList.remove('from-red-500');
            bar.classList.add('from-cyan-400', 'to-white');
            
            // Shake
            camera.position.y += 2;
            setTimeout(() => { camera.position.y = 10; }, 100);
        }

        function updateBots() {
            // Update local bot logic
            bots.forEach(bot => {
                const botMax = boostActive ? bot.maxSpeed : bot.maxSpeed;
                
                // Acceleration
                if (bot.speed < botMax) {
                    bot.speed += bot.accel;
                }
                
                // Steering
                if (Math.random() < 0.05) {
                    bot.targetX = (Math.random() * (TRACK_W - 10)) - (TRACK_W/2) + 5;
                }
                
                const dx = bot.targetX - bot.x;
                if (Math.abs(dx) > 0.5) {
                    bot.x += Math.sign(dx) * 0.1;
                }

                // Move forward
                bot.z += bot.speed * 2.5;

                // Sync
                if (opponentCars[bot.id]) {
                    opponentCars[bot.id].position.z = bot.z;
                    opponentCars[bot.id].position.x = bot.x;
                }
                
                if(playersMap[bot.id]) {
                    playersMap[bot.id].z = bot.z;
                }
            });
        }

        function startGameLoop() {
            let lastSync = 0;
            
            function loop() {
                if (gameStatus !== 'racing') return;
                requestAnimationFrame(loop);
                
                // Physics
                let targetAccel = phys.accel;
                let targetMaxSpeed = phys.maxSpeed;
                
                // Boost Logic
                if (boostCooldown > 0) {
                    boostCooldown--;
                    if (boostActive) {
                        targetMaxSpeed *= BOOST_MULTIPLIER;
                        targetAccel *= 3.0; 
                        if (currentSpeed < phys.maxSpeed * BOOST_MULTIPLIER) {
                            currentSpeed += targetAccel * 2;
                        }
                        myCar.rotation.y += Math.sin(boostCooldown * 0.2) * 0.01;
                    }
                    if (boostCooldown <= 0) {
                        boostActive = false;
                        if (currentSpeed > phys.maxSpeed) currentSpeed = phys.maxSpeed;
                        const bar = document.getElementById('boost-bar');
                        bar.classList.add('from-red-500');
                        bar.classList.remove('from-cyan-400', 'to-white');
                    }
                }

                // Car Movement (Skip if Respawning)
                if (!isRespawning) {
                    if (inputState.holding) {
                        const speedRatio = currentSpeed / targetMaxSpeed;
                        const torqueCurve = Math.max(0.2, 1.0 - Math.pow(speedRatio, 2)); 
                        currentSpeed += (targetAccel * 2.5) * torqueCurve;
                    } else {
                        currentSpeed *= 0.97;
                    }

                    if (currentSpeed > targetMaxSpeed) currentSpeed = targetMaxSpeed;
                    
                    if (currentSpeed > 0.1) {
                        myCar.position.x += inputState.steer * phys.turnSpeed;
                        myCar.rotation.z = -inputState.steer * 0.15;
                        myCar.rotation.y = -inputState.steer * 0.1;
                    }

                    myCar.position.z += currentSpeed * 2.5;
                }

                // Bounds
                const lim = TRACK_W/2 - 2;
                if(myCar.position.x > lim) myCar.position.x = lim;
                if(myCar.position.x < -lim) myCar.position.x = -lim;

                // Collisions -> RESPAWN LOGIC
                if (!isRespawning) {
                    const carBox = new THREE.Box3().setFromObject(myCar);
                    carBox.expandByScalar(-0.5);
                    for (let ob of obstacles) {
                        if (carBox.intersectsBox(ob)) {
                            // Trigger Respawn Penalty
                            triggerRespawn();
                        }
                    }
                }

                // Camera Follow
                camera.position.z = myCar.position.z - 18;
                camera.position.x += (myCar.position.x*0.5 - camera.position.x) * 0.1;
                camera.lookAt(myCar.position.x * 0.2, 0, myCar.position.z + 10);

                // HUD
                document.getElementById('hud-speed').innerText = Math.floor(currentSpeed * 120);

                // AI / Multiplayer Sync
                if (isSinglePlayer) {
                    updateBots();
                    if(playersMap[userProfile.uid]) playersMap[userProfile.uid].z = myCar.position.z;
                } else {
                    if (Date.now() - lastSync > 100) {
                        lastSync = Date.now();
                        const rRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId);
                        updateDoc(rRef, {
                            [`players.${userProfile.uid}.x`]: Number(myCar.position.x.toFixed(2)),
                            [`players.${userProfile.uid}.z`]: Number(myCar.position.z.toFixed(2)),
                        }).catch(()=>{});
                    }
                    Object.entries(playersMap).forEach(([uid, p]) => {
                        if (uid === userProfile.uid) return;
                        if (opponentCars[uid]) {
                            opponentCars[uid].position.x += (p.x - opponentCars[uid].position.x) * 0.1;
                            opponentCars[uid].position.z += (p.z - opponentCars[uid].position.z) * 0.1;
                        }
                    });
                }

                // Pos Calc
                let rank = 1;
                Object.entries(playersMap).forEach(([uid, p]) => {
                    if (uid !== userProfile.uid && p.z > myCar.position.z) rank++;
                });
                document.getElementById('hud-pos').innerText = `${rank}/${Object.keys(playersMap).length}`;

                // Finish
                if (myCar.position.z >= TRACK_LEN) {
                    finishRace(rank);
                }

                // Render
                if (isRespawning) {
                    // Blink effect
                    myCar.visible = Math.floor(Date.now() / 100) % 2 === 0;
                } else {
                    myCar.visible = true;
                }
                renderer.render(scene, camera);
            }
            loop();
        }

        function triggerRespawn() {
            isRespawning = true;
            currentSpeed = 0; // Stop dead
            
            // Camera Shake for Impact
            camera.position.x += (Math.random()-0.5) * 5;
            camera.position.y += (Math.random()-0.5) * 5;

            // Wait 1.5 seconds then resume
            setTimeout(() => {
                isRespawning = false;
                // Move slightly safe
                myCar.position.x = 0; 
                // Don't reset Z, user said "respawned where i died"
            }, 1500);
        }

       async function finishRace(rank) {
            gameStatus = 'finished';
            if (roomUnsubscribe) { roomUnsubscribe(); roomUnsubscribe = null; }
            
            // Calculate Reward 
            // 1st: 600, 2nd: 500, 3rd: 400, 4th: 300, 5th: 200
            let reward = 200; // Base/Last
            if (rank === 1) reward = 600;
            else if (rank === 2) reward = 500;
            else if (rank === 3) reward = 400;
            else if (rank === 4) reward = 300;

            userProfile.cash += reward;
            
            // Level Progression Logic
            const lvlMsg = document.getElementById('level-up-msg');
            if (isSinglePlayer && rank === 1) {
                if (userProfile.currentLevel < 100) {
                    userProfile.currentLevel++;
                    lvlMsg.classList.remove('hidden');
                    lvlMsg.innerText = `LEVEL UP! NOW LEVEL ${userProfile.currentLevel}`;
                } else {
                    lvlMsg.classList.remove('hidden');
                    lvlMsg.innerText = `MAX LEVEL REACHED!`;
                }
            } else {
                lvlMsg.classList.add('hidden');
            }

            await saveProfile();

            document.getElementById('result-panel').classList.remove('hidden-panel');
            document.getElementById('result-pos').innerText = `#${rank}`;
            document.getElementById('result-money').innerText = reward;
        }

        function mulberry32(a) {
            return function() {
                var t = a += 0x6D2B79F5;
                t = Math.imul(t ^ t >>> 15, t | 1);
                t ^= t + Math.imul(t ^ t >>> 7, t | 61);
                return ((t ^ t >>> 14) >>> 0) / 4294967296;
            }
        }
        
        // Initialize
        (async function init() {
            try {
                await initAuth();
                console.log("Auth initialized");
            } catch (error) {
                console.error("Fatal init error:", error);
                document.getElementById('loading-text').innerText = "Connection Failed. Refresh to retry.";
                setTimeout(() => {
                    document.getElementById('loading-panel').classList.add('hidden-panel');
                    document.getElementById('menu-panel').classList.remove('hidden-panel');
                    alert("Running in offline mode. Multiplayer disabled.");
                }, 3000);
            }
        })();

    </script>
</body>
</html>
